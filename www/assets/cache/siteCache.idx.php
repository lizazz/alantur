<?php
$c=&$this->config;
$c['manager_theme'] = "MODxRE";
$c['settings_version'] = "1.0.15";
$c['show_meta'] = "0";
$c['server_offset_time'] = "0";
$c['server_protocol'] = "http";
$c['manager_language'] = "russian-UTF8";
$c['modx_charset'] = "UTF-8";
$c['site_name'] = "Alantur";
$c['site_start'] = "2";
$c['error_page'] = "21";
$c['unauthorized_page'] = "21";
$c['site_status'] = "1";
$c['site_unavailable_message'] = "Сайт временно не доступен";
$c['track_visitors'] = "0";
$c['top_howmany'] = "10";
$c['auto_template_logic'] = "parent";
$c['default_template'] = "3";
$c['old_template'] = "3";
$c['publish_default'] = "1";
$c['cache_default'] = "0";
$c['search_default'] = "1";
$c['friendly_urls'] = "1";
$c['friendly_url_prefix'] = "";
$c['friendly_url_suffix'] = "";
$c['friendly_alias_urls'] = "1";
$c['use_alias_path'] = "1";
$c['use_udperms'] = "1";
$c['udperms_allowroot'] = "0";
$c['failed_login_attempts'] = "3";
$c['blocked_minutes'] = "60";
$c['use_captcha'] = "0";
$c['captcha_words'] = "MODX,Access,Better,BitCode,Cache,Desc,Design,Excell,Enjoy,URLs,TechView,Gerald,Griff,Humphrey,Holiday,Intel,Integration,Joystick,Join(),Tattoo,Genetic,Light,Likeness,Marit,Maaike,Niche,Netherlands,Ordinance,Oscillo,Parser,Phusion,Query,Question,Regalia,Righteous,Snippet,Sentinel,Template,Thespian,Unity,Enterprise,Verily,Veri,Website,WideWeb,Yap,Yellow,Zebra,Zygote";
$c['emailsender'] = "lizazz@yandex.ru";
$c['email_method'] = "smtp";
$c['smtp_auth'] = "1";
$c['smtp_host'] = "mail.artjoker.ua";
$c['smtp_port'] = "587";
$c['smtp_username'] = "art.digital@artjoker.ua";
$c['emailsubject'] = "Данные о регистрации";
$c['number_of_logs'] = "100";
$c['number_of_messages'] = "30";
$c['number_of_results'] = "20";
$c['use_editor'] = "1";
$c['use_browser'] = "1";
$c['rb_base_dir'] = "/var/www/alantur.loc/www/assets/";
$c['rb_base_url'] = "assets/";
$c['which_editor'] = "TinyMCE";
$c['fe_editor_lang'] = "russian-UTF8";
$c['fck_editor_toolbar'] = "standard";
$c['fck_editor_autolang'] = "0";
$c['editor_css_path'] = "";
$c['editor_css_selectors'] = "";
$c['strip_image_paths'] = "1";
$c['upload_images'] = "bmp,ico,gif,jpeg,jpg,png,psd,tif,tiff";
$c['upload_media'] = "au,avi,mp3,mp4,mpeg,mpg,wav,wmv";
$c['upload_flash'] = "fla,flv,swf";
$c['upload_files'] = "aac,au,avi,css,cache,doc,docx,gz,gzip,htaccess,htm,html,js,mp3,mp4,mpeg,mpg,ods,odp,odt,pdf,ppt,pptx,rar,tar,tgz,txt,wav,wmv,xls,xlsx,xml,z,zip";
$c['upload_maxsize'] = "1048576";
$c['new_file_permissions'] = "0644";
$c['new_folder_permissions'] = "0755";
$c['filemanager_path'] = "/var/www/alantur.loc/www/";
$c['theme_refresher'] = "";
$c['manager_layout'] = "4";
$c['custom_contenttype'] = "application/rss+xml,application/pdf,application/vnd.ms-word,application/vnd.ms-excel,text/html,text/css,text/xml,text/javascript,text/plain,application/json";
$c['auto_menuindex'] = "1";
$c['session.cookie.lifetime'] = "604800";
$c['mail_check_timeperiod'] = "60";
$c['manager_direction'] = "ltr";
$c['tinymce_editor_theme'] = "editor";
$c['tinymce_custom_plugins'] = "style,advimage,advlink,searchreplace,print,contextmenu,paste,fullscreen,nonbreaking,xhtmlxtras,visualchars,media";
$c['tinymce_custom_buttons1'] = "undo,redo,selectall,separator,pastetext,pasteword,separator,search,replace,separator,nonbreaking,hr,charmap,separator,image,link,unlink,anchor,media,separator,cleanup,removeformat,separator,fullscreen,print,code,help";
$c['tinymce_custom_buttons2'] = "bold,italic,underline,strikethrough,sub,sup,separator,bullist,numlist,outdent,indent,separator,justifyleft,justifycenter,justifyright,justifyfull,separator,styleselect,formatselect,separator,styleprops";
$c['tree_show_protected'] = "0";
$c['rss_url_news'] = "http://feeds.feedburner.com/modx-announce";
$c['rss_url_security'] = "http://feeds.feedburner.com/modxsecurity";
$c['validate_referer'] = "1";
$c['datepicker_offset'] = "-10";
$c['xhtml_urls'] = "1";
$c['allow_duplicate_alias'] = "1";
$c['automatic_alias'] = "1";
$c['datetime_format'] = "dd-mm-YYYY";
$c['warning_visibility'] = "1";
$c['remember_last_tab'] = "0";
$c['enable_bindings'] = "1";
$c['seostrict'] = "0";
$c['cache_type'] = "1";
$c['maxImageWidth'] = "1600";
$c['maxImageHeight'] = "1200";
$c['thumbWidth'] = "150";
$c['thumbHeight'] = "150";
$c['thumbsDir'] = ".thumbs";
$c['jpegQuality'] = "90";
$c['denyZipDownload'] = "0";
$c['denyExtensionRename'] = "0";
$c['showHiddenFiles'] = "0";
$c['docid_incrmnt_method'] = "0";
$c['make_folders'] = "1";
$c['site_id'] = "55223a3e8f8bd";
$c['site_unavailable_page'] = "";
$c['reload_site_unavailable'] = "";
$c['siteunavailable_message_default'] = "В настоящее время сайт недоступен.";
$c['check_files_onlogin'] = "index.php\r\n.htaccess\r\nmanager/index.php\r\nmanager/includes/config.inc.php";
$c['error_reporting'] = "1";
$c['send_errormail'] = "0";
$c['pwd_hash_algo'] = "UNCRYPT";
$c['reload_captcha_words'] = "";
$c['captcha_words_default'] = "MODX,Access,Better,BitCode,Chunk,Cache,Desc,Design,Excell,Enjoy,URLs,TechView,Gerald,Griff,Humphrey,Holiday,Intel,Integration,Joystick,Join(),Oscope,Genetic,Light,Likeness,Marit,Maaike,Niche,Netherlands,Ordinance,Oscillo,Parser,Phusion,Query,Question,Regalia,Righteous,Snippet,Sentinel,Template,Thespian,Unity,Enterprise,Verily,Tattoo,Veri,Website,WideWeb,Yap,Yellow,Zebra,Zygote";
$c['smtp_secure'] = "none";
$c['reload_emailsubject'] = "";
$c['emailsubject_default'] = "Данные для авторизации";
$c['reload_signupemail_message'] = "";
$c['signupemail_message'] = "Здравствуйте, [+uid+]!\r\n\r\nВаши данные для авторизации в системе управления сайтом [+sname+]:\r\n\r\nИмя пользователя: [+uid+]\r\nПароль: [+pwd+]\r\n";
$c['system_email_signup_default'] = "Здравствуйте, [+uid+]!\r\n\r\nВаши данные для авторизации в системе управления сайтом [+sname+]:\r\n\r\nИмя пользователя: [+uid+]\r\nПароль: [+pwd+]\r\n\r\nПосле успешной авторизации в системе управления сайтом ([+surl+]), вы сможете изменить свой пароль.\r\n\r\nС уважением, Администрация";
$c['reload_websignupemail_message'] = "";
$c['websignupemail_message'] = "Здравствуйте, [+uid+]!\r\n\r\nЧтобы активировать ваш новый пароль, перейдите по следующей ссылке:\r\n\r\n[+surl+]\r\n\r\nПозже вы сможете использовать следующий пароль для авторизации: [+pwd+]\r\n\r\nЕсли это письмо пришло к вам по ошибке, пожалуйста, проигнорируйте его.\r\n\r\nС уважением, Администрация";
$c['system_email_websignup_default'] = "Здравствуйте, [+uid+]!\r\n\r\nВаши данные для авторизации на [+sname+]:\r\n\r\nИмя пользователя: [+uid+]\r\nПароль: [+pwd+]\r\n\r\nПосле успешной авторизации на [+sname+] ([+surl+]), вы сможете изменить свой пароль.\r\n\r\nС уважением, Администрация";
$c['reload_system_email_webreminder_message'] = "";
$c['webpwdreminder_message'] = "????????????, [+uid+]!\r\n\r\n????? ???????????? ??? ????? ??????, ????????? ?? ????????? ??????:\r\n\r\n[+surl+]\r\n\r\n????? ?? ??????? ???????????? ????????? ?????? ??? ???????????: [+pwd+]\r\n\r\n???? ??? ?????? ?????? ? ??? ?? ??????, ??????????, ?????????????? ???.\r\n\r\n? ?????????, ?????????????";
$c['system_email_webreminder_default'] = "Здравствуйте, [+uid+]!\r\n\r\nЧтобы активировать ваш новый пароль, перейдите по следующей ссылке:\r\n\r\n[+surl+]\r\n\r\nПозже вы сможете использовать следующий пароль для авторизации: [+pwd+]\r\n\r\nЕсли это письмо пришло к вам по ошибке, пожалуйста, проигнорируйте его.\r\n\r\nС уважением, Администрация";
$c['tree_page_click'] = "3";
$c['resource_tree_node_name'] = "pagetitle";
$c['mce_editor_skin'] = "default";
$c['mce_template_docs'] = "";
$c['mce_template_chunks'] = "";
$c['mce_entermode'] = "p";
$c['mce_element_format'] = "xhtml";
$c['mce_schema'] = "html4";
$c['tinymce_custom_buttons3'] = "";
$c['tinymce_custom_buttons4'] = "";
$c['tinymce_css_selectors'] = "left=justifyleft;right=justifyright";
$c['rb_webuser'] = "0";
$c['clean_uploaded_filename'] = "0";
$c['sys_files_checksum'] = "a:4:{s:34:\"/var/www/alantur.loc/www/index.php\";s:32:\"c6f73908b7b0a58acfe95b0f844d134e\";s:34:\"/var/www/alantur.loc/www/.htaccess\";s:32:\"14315112f5bb1557d6a90515051ac2c3\";s:42:\"/var/www/alantur.loc/www/manager/index.php\";s:32:\"30df65e2d71987b65a4258e318c21aaf\";s:56:\"/var/www/alantur.loc/www/manager/includes/config.inc.php\";s:32:\"b17083841823e79fedd69949198fa0bb\";}";
$c['smtppw'] = "eTVrcmw5bTU%XJx7bfm";
$this->aliasListing = array();
$a = &$this->aliasListing;
$d = &$this->documentListing;
$m = &$this->documentMap;
$d['minimal-base'] = 1;
$a[1] = array('id' => 1, 'alias' => 'minimal-base', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '1');
$d['index'] = 2;
$a[2] = array('id' => 2, 'alias' => 'index', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '2');
$d['tours'] = 3;
$a[3] = array('id' => 3, 'alias' => 'tours', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '3');
$d['countries'] = 4;
$a[4] = array('id' => 4, 'alias' => 'countries', 'path' => '', 'parent' => 0, 'isfolder' => 1);
$m[] = array('0' => '4');
$d['type'] = 7;
$a[7] = array('id' => 7, 'alias' => 'type', 'path' => '', 'parent' => 0, 'isfolder' => 1);
$m[] = array('0' => '7');
$d['filter'] = 10;
$a[10] = array('id' => 10, 'alias' => 'filter', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '10');
$d['one-tour'] = 11;
$a[11] = array('id' => 11, 'alias' => 'one-tour', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '11');
$d['userpage'] = 12;
$a[12] = array('id' => 12, 'alias' => 'userpage', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '12');
$d['registration'] = 13;
$a[13] = array('id' => 13, 'alias' => 'registration', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '13');
$d['reports'] = 15;
$a[15] = array('id' => 15, 'alias' => 'reports', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '15');
$d['new-report'] = 16;
$a[16] = array('id' => 16, 'alias' => 'new-report', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '16');
$d['one-report'] = 17;
$a[17] = array('id' => 17, 'alias' => 'one-report', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '17');
$d['about'] = 18;
$a[18] = array('id' => 18, 'alias' => 'about', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '18');
$d['contacts'] = 19;
$a[19] = array('id' => 19, 'alias' => 'contacts', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '19');
$d['create-report'] = 20;
$a[20] = array('id' => 20, 'alias' => 'create-report', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '20');
$d['404'] = 21;
$a[21] = array('id' => 21, 'alias' => '404', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '21');
$d['after-order'] = 22;
$a[22] = array('id' => 22, 'alias' => 'after-order', 'path' => '', 'parent' => 0, 'isfolder' => 0);
$m[] = array('0' => '22');
$d['countries/ukraine'] = 5;
$a[5] = array('id' => 5, 'alias' => 'ukraine', 'path' => 'countries', 'parent' => 4, 'isfolder' => 0);
$m[] = array('4' => '5');
$d['countries/england'] = 6;
$a[6] = array('id' => 6, 'alias' => 'england', 'path' => 'countries', 'parent' => 4, 'isfolder' => 0);
$m[] = array('4' => '6');
$d['countries/cyprus'] = 28;
$a[28] = array('id' => 28, 'alias' => 'cyprus', 'path' => 'countries', 'parent' => 4, 'isfolder' => 0);
$m[] = array('4' => '28');
$d['countries/german'] = 27;
$a[27] = array('id' => 27, 'alias' => 'german', 'path' => 'countries', 'parent' => 4, 'isfolder' => 0);
$m[] = array('4' => '27');
$d['countries/нидерланды'] = 24;
$a[24] = array('id' => 24, 'alias' => 'нидерланды', 'path' => 'countries', 'parent' => 4, 'isfolder' => 0);
$m[] = array('4' => '24');
$d['countries/poland'] = 25;
$a[25] = array('id' => 25, 'alias' => 'poland', 'path' => 'countries', 'parent' => 4, 'isfolder' => 0);
$m[] = array('4' => '25');
$d['type/bus-tour'] = 26;
$a[26] = array('id' => 26, 'alias' => 'bus-tour', 'path' => 'type', 'parent' => 7, 'isfolder' => 0);
$m[] = array('7' => '26');
$d['type/альтернативный-отдых'] = 23;
$a[23] = array('id' => 23, 'alias' => 'альтернативный-отдых', 'path' => 'type', 'parent' => 7, 'isfolder' => 0);
$m[] = array('7' => '23');
$d['type/экстримальный'] = 9;
$a[9] = array('id' => 9, 'alias' => 'экстримальный', 'path' => 'type', 'parent' => 7, 'isfolder' => 0);
$m[] = array('7' => '9');
$d['type/military'] = 8;
$a[8] = array('id' => 8, 'alias' => 'military', 'path' => 'type', 'parent' => 7, 'isfolder' => 0);
$m[] = array('7' => '8');
$d['type/beach-holiday'] = 34;
$a[34] = array('id' => 34, 'alias' => 'beach-holiday', 'path' => 'type', 'parent' => 7, 'isfolder' => 0);
$m[] = array('7' => '34');
$c = &$this->contentTypes;
$c = &$this->chunkCache;
$c['mm_rules'] = '// more example rules are in assets/plugins/managermanager/example_mm_rules.inc.php
// example of how PHP is allowed - check that a TV named documentTags exists before creating rule

if ($modx->db->getValue($modx->db->select(\'count(id)\', $modx->getFullTableName(\'site_tmplvars\'), "name=\'documentTags\'"))) {
	mm_widget_tags(\'documentTags\', \' \'); // Give blog tag editing capabilities to the \'documentTags (3)\' TV
}
mm_widget_showimagetvs(); // Always give a preview of Image TVs
mm_ddGMap(\'lat_lng\');';
$c['WebLoginSideBar'] = '<!-- #declare:separator <hr> -->
<!-- login form section-->
<form method="post" name="loginfrm" action="[+action+]">
    <input type="hidden" value="[+rememberme+]" name="rememberme" />
    <fieldset>
        <h3>Your Login Details</h3>
        <label for="username">User: <input type="text" name="username" id="username" tabindex="1" onkeypress="return webLoginEnter(document.loginfrm.password);" value="[+username+]" /></label>
    	<label for="password">Password: <input type="password" name="password" id="password" tabindex="2" onkeypress="return webLoginEnter(document.loginfrm.cmdweblogin);" value="" /></label>
    	<input type="checkbox" id="checkbox_1" name="checkbox_1" tabindex="3" size="1" value="" [+checkbox+] onclick="webLoginCheckRemember()" /><label for="checkbox_1" class="checkbox">Remember me</label>
    	<input type="submit" value="[+logintext+]" name="cmdweblogin" class="button" />
	<a href="#" onclick="webLoginShowForm(2);return false;" id="forgotpsswd">Forget Your Password?</a>
	</fieldset>
</form>
<hr>
<!-- log out hyperlink section -->
<h4>You\'re already logged in</h4>
Do you wish to <a href="[+action+]" class="button">[+logouttext+]</a>?
<hr>
<!-- Password reminder form section -->
<form name="loginreminder" method="post" action="[+action+]">
    <fieldset>
        <h3>It happens to everyone...</h3>
        <input type="hidden" name="txtpwdrem" value="0" />
        <label for="txtwebemail">Enter the email address of your account to reset your password: <input type="text" name="txtwebemail" id="txtwebemail" size="24" /></label>
        <label>To return to the login form, press the cancel button.</label>
    	<input type="submit" value="Submit" name="cmdweblogin" class="button" /> <input type="reset" value="Cancel" name="cmdcancel" onclick="webLoginShowForm(1);" class="button" style="clear:none;display:inline" />
    </fieldset>
</form>

';
$c['HEAD'] = '<!DOCTYPE HTML>
<html lang="en-US">
	<head>
		<title>alantur</title>
		<meta charset="UTF-8">
		<link href="/assets/site/bootstrap3/css/bootstrap.min.css" rel="stylesheet">
		<link href="/assets/site/bootstrap3/css/bootstrap-theme.min.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="/assets/templates/alantur/css/style.css">
		<link rel="stylesheet" type="text/css" href="/assets/templates/alantur/css/jquery.fancybox-1.3.4.css">
		<script type="text/javascript" src="/assets/js/jquery.min.js"></script>
		<script src="/assets/site/bootstrap3/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="/assets/js/jquery-1.8.3.min.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
		<script type="text/javascript" src="/assets/js/jquery.raty.min.js"></script>
		<script type="text/javascript" src="/assets/js/jquery.fancybox-1.3.4.pack.js"></script>
		<script type="text/javascript" src="/assets/js/jquery.validate.min.js"></script>
		<script type="text/javascript" src="/assets/js/jquery.cookie.js"></script>
		<script type="text/javascript" src="/assets/js/main.js"></script>
		<script src=\'https://www.google.com/recaptcha/api.js\'></script>
	</head>
	<body>';
$c['main_menu'] = '<!-- Main menu-->	
<div class="container">
	<div class="row">				
					<nav class="navbar navbar-default">
						<!-- Brand and toggle get grouped for better mobile display -->
						<div class="navbar-header">
						  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						  </button>
						  <a class="navbar-brand" href="/">Alantur</a>
						</div>
					
						<!-- Collect the nav links, forms, and other content for toggling -->
						<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
						  <ul class="nav navbar-nav">
							  <li><a href="/"> Главная <span class="sr-only">(current)</span></a></li>
							  <li><a href="/tours">Туры</a></li>
							  [[if? &is=`[*user_webuser*]:not_empty` &then=`<li><a href="/userpage">Личный кабинет</a></li>`]]
							  <li><a href="/reports">Фотоотчеты</a></li>
							  <li><a href="/about">О нас</a></li>
							  <li><a href="/contacts">Контакты</a></li>
						  </ul>
						  <ul class="nav navbar-nav btn-reg active navbar-right">
								[[if? &is=`[*user_webuser*]:empty` &then=`<li><a href="/registration" >Регистрация и авторизация</a></li>` &else=`<li><a href="" class="logout">Выход</a></li>`]]
						  </ul>
						</div><!-- /.navbar-collapse -->
					</nav>	
	</div>
	<div class="row text-center">
					<form class="navbar-form" role="search" method="GET" action="/tours">
						<div class="form-group">
						 	<input type="text" class="form-control" placeholder="Search" value="[[snippet? &get = `get_search`]]" name="search">
						</div>
						<input type="submit" class="btn btn-default">
					</form>	
	</div>';
$c['tpl_option'] = '<option value="[+id+]">[+pagetitle+]</option>';
$c['tpl_country'] = '<div class="form-group text-left">
	<label>
		<input type="radio" name="country" value="[+id+]" class="radio-inline">
		[+pagetitle+]
	</label>
</div>';
$c['tpl_tours'] = '<div class = "col-md-3">
	<h3><a href="/tours/{path}" class="">{title}</a></h3>
	<a href="/tours/{path}" class="">
			<img src="{image} " class="img-thumbnail"/>
	</a>	
	<div>Страна тура: {country}</div>
	<div>Количество отчетов: {reports}</div>
</div>';
$c['tpl_kind'] = '<div class="form-group text-left">
	<label>
		<input type="checkbox" name="type[]" class="checkbox-inline" [[if?is=`[+id+]:inarray:[*type*]`&then=`checked `]] value="[+id+]">
		[+pagetitle+]
	</label>	
</div>';
$c['active_page'] = '<span class="active">{page}</span>';
$c['last_page'] = '
<a href="{page}">{page}</a>';
$c['tpl_image_of_tour'] = '<a class="fancybox" rel="group" href="{image}" title="<>">
	<img src="{image}" width = "250px" class="thumbnail img-responsive" alt="" />
</a>';
$c['tpl_type_one_tour'] = '<div><a href="/tours?type%5B%5D={type_id}" class="">{type_title}</a></div>';
$c['FOOTER'] = '</div><!-- /.container-fluid -->
	</body>
</html>';
$c['tpl_orders'] = '<div class = "col-md-3">
	<h3>{title}</h3>
	<img src="/assets/images/reports/{id_order}/{photo_name}" class="img-thumbnail"/>
	<a class="btn btn-success" href="/new-report?report={id_order}">Редактировать отчет</a>
	<button class="btn btn-small btn-danger del-report" data-folder="{id_order}" >Удалить отчет</button>
	<div>Статус отчета: {moderation}</div>
</div>';
$c['tpl_edit_report'] = '<div class="col-md-3">
	<a class="fancybox" rel="group" href="/assets/images/reports/{id_order}/{photo_name}" title="{description}">
		<img src="[[R?&img=`/assets/images/reports/{id_order}/{photo_name}`&opt=`w=250&far=1`]]" class="img-thumbnail" />
	</a>
	<br>
	<span><textarea class="form-control" name = "upd-desc[{id_photo}]">{description}</textarea><span>
	<br>
	<button class="btn btn-small btn-danger del-foto" data-img="{id_photo}" data-folder="{id_order}" data-fotoname ="{photo_name}">Удалить фотографию</button>
</div>
';
$c['tpl_no_photo_edit'] = '<div class = "col-md-3 element">
	<h3>{title}</h3>
	<div>В этом отчете пока нет фотографий, вы можете добавить первую</div>
	<div><a class="btn btn-success" href="/new-report?report={id_order}">Редактировать отчет</a></div>
	<button class="btn btn-small btn-danger del-report" data-folder="{id_order}" >Удалить отчет</button>
	<div>Статус отчета: {moderation}</div>
</div>';
$c['tpl_no_photo_noauth'] = '<div class = "col-md-3">
	<h3> {title}</h3>
	<div>Отчет пуст</div>
</div>';
$c['tpl_show_report'] = '<a class="fancybox" rel="group" href="/assets/images/reports/{id_order}/{photo_name}" title="{description}">
	<img src="[[R?&img=`/assets/images/reports/{id_order}/{photo_name}`&opt=`w=420&far=1`]]" class="img-thumbnail"/></a>
	<div>{description}</div>
</a>
';
$c['tpl_orders_noauth'] = '<div class = "col-md-3">
		<a href="/one-report?report={id_order}"><img src="[[R?&img=`/assets/images/reports/{id_order}/{photo_name}`&opt=`w=250&far=1`]]"  class="img-thumbnail"/></a>	
		<a href="/one-report?report={id_order}">Ознакомится с отчетом</a>	
	<div class="js_star stars" data-rating="{rate}" data-order="{id_order}"></div>
	<div>Поставьте оценку отчету</div>
</div>';
$c['tpl_no_tour'] = '<div class = "col-md-3">Нет туров удовлетворяющих условию</div>';
$c['email'] = '"hellp"{name}';
$c['tpl_captcha'] = '<div class=\'g-recaptcha\' data-sitekey=\'{key}\'></div>';
$c['email_letter'] = '<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Регистрация</title>
</head>
<body> 
	<div>Вы получили письмо от {name}</div>
	<div>Тел. {phone}</div>
	<div>Текст сообщения</div>
	<div>{message}</div>
</body>
</html>';
$c['tpl_paging'] = '<a href="/tours?nextpage={page}">{page}</a>';
$c['tpl_user_orders'] = '<tr>
	<td class="info"><a href="/tours/{path}">{title}</a></td>
	<td class="info">{status_word}</td>
<tr>';
$c['tpl_table_header'] = '<thead class="table-hover">
	<tr>
		<td class="success"><b>Название тура</b></td>
		<td class="success"><b>Статус тура тура</b></td>
		
	</tr>
</thead>';
$c['buy_tour'] = '<button class="btn btn-small btn-success buy_tour" data-tourid=[*id*] data-userid=[*user_webuser*] data-price=[*price*]>Купить тур за [*price*] грн.</button>';
$c['cant_buy'] = '<div class="lead">Вы можете купить этот тур за [*price*] грн., но для этого Вам необходимо <a href="/registration#auth_form">авторизироваться</a></div>';
$s = &$this->snippetCache;
$s['AjaxSearch'] = 'return require MODX_BASE_PATH.\'assets/snippets/ajaxSearch/snippet.ajaxSearch.php\';';
$s['AjaxSearch'] = 'return require MODX_BASE_PATH.\'assets/snippets/ajaxSearch/snippet.ajaxSearch.php\';';
$s['Wayfinder'] = 'return require MODX_BASE_PATH.\'assets/snippets/wayfinder/snippet.wayfinder.php\';
';
$s['Wayfinder'] = 'return require MODX_BASE_PATH.\'assets/snippets/wayfinder/snippet.wayfinder.php\';
';
$s['if'] = 'return require MODX_BASE_PATH.\'assets/snippets/if/snippet.if.php\';';
$s['if'] = 'return require MODX_BASE_PATH.\'assets/snippets/if/snippet.if.php\';';
$s['FirstChildRedirect'] = 'return require MODX_BASE_PATH.\'assets/snippets/firstchildredirect/snippet.firstchildredirect.php\';';
$s['FirstChildRedirect'] = 'return require MODX_BASE_PATH.\'assets/snippets/firstchildredirect/snippet.firstchildredirect.php\';';
$s['MemberCheck'] = 'return require MODX_BASE_PATH.\'assets/snippets/membercheck/snippet.membercheck.php\';';
$s['MemberCheck'] = 'return require MODX_BASE_PATH.\'assets/snippets/membercheck/snippet.membercheck.php\';';
$s['WebSignup'] = '# Created By Raymond Irving April, 2005
#::::::::::::::::::::::::::::::::::::::::
# Usage:     
#    Allows a web user to signup for a new web account from the website
#    This snippet provides a basic set of form fields for the signup form
#    You can customize this snippet to create your own signup form
#
# Params:    
#
#    &tpl        - (Optional) Chunk name or document id to use as a template
#	    		   If custom template AND captcha on AND using WebSignup and 
#                  WebLogin on the same page make sure you have a field named
#                  cmdwebsignup. In the default template it is the submit button 
#                  One can use a hidden field.
#    &groups     - Web users groups to be assigned to users
#    &useCaptcha - (Optional) Determine to use (1) or not to use (0) captcha
#                  on signup form - if not defined, will default to system
#                  setting. GD is required for this feature. If GD is not 
#                  available, useCaptcha will automatically be set to false;
#                  
#    Note: Templats design:
#        section 1: signup template
#        section 2: notification template 
#
# Examples:
#
#    [[WebSignup? &tpl=`SignupForm` &groups=`NewsReaders,WebUsers`]] 

# Set Snippet Paths 
$snipPath = $modx->config[\'base_path\'] . "assets/snippets/";

# check if inside manager
if ($m = $modx->isBackend()) {
    return \'\'; # don\'t go any further when inside manager
}


# Snippet customize settings
$tpl = isset($tpl)? $tpl:"";
$useCaptcha = isset($useCaptcha)? $useCaptcha : $modx->config[\'use_captcha\'] ;
// Override captcha if no GD
if ($useCaptcha && !gd_info()) $useCaptcha = 0;

# setup web groups
$groups = isset($groups) ? array_filter(array_map(\'trim\', explode(\',\', $groups))):array();

# System settings
$isPostBack        = count($_POST) && isset($_POST[\'cmdwebsignup\']);

$output = \'\';

# Start processing
include_once $snipPath."weblogin/weblogin.common.inc.php";
include_once $snipPath."weblogin/websignup.inc.php";

# Return
return $output;';
$s['WebSignupProps'] = '&tpl=Template;string; ';
$s['WebSignup'] = '# Created By Raymond Irving April, 2005
#::::::::::::::::::::::::::::::::::::::::
# Usage:     
#    Allows a web user to signup for a new web account from the website
#    This snippet provides a basic set of form fields for the signup form
#    You can customize this snippet to create your own signup form
#
# Params:    
#
#    &tpl        - (Optional) Chunk name or document id to use as a template
#	    		   If custom template AND captcha on AND using WebSignup and 
#                  WebLogin on the same page make sure you have a field named
#                  cmdwebsignup. In the default template it is the submit button 
#                  One can use a hidden field.
#    &groups     - Web users groups to be assigned to users
#    &useCaptcha - (Optional) Determine to use (1) or not to use (0) captcha
#                  on signup form - if not defined, will default to system
#                  setting. GD is required for this feature. If GD is not 
#                  available, useCaptcha will automatically be set to false;
#                  
#    Note: Templats design:
#        section 1: signup template
#        section 2: notification template 
#
# Examples:
#
#    [[WebSignup? &tpl=`SignupForm` &groups=`NewsReaders,WebUsers`]] 

# Set Snippet Paths 
$snipPath = $modx->config[\'base_path\'] . "assets/snippets/";

# check if inside manager
if ($m = $modx->isBackend()) {
    return \'\'; # don\'t go any further when inside manager
}


# Snippet customize settings
$tpl = isset($tpl)? $tpl:"";
$useCaptcha = isset($useCaptcha)? $useCaptcha : $modx->config[\'use_captcha\'] ;
// Override captcha if no GD
if ($useCaptcha && !gd_info()) $useCaptcha = 0;

# setup web groups
$groups = isset($groups) ? array_filter(array_map(\'trim\', explode(\',\', $groups))):array();

# System settings
$isPostBack        = count($_POST) && isset($_POST[\'cmdwebsignup\']);

$output = \'\';

# Start processing
include_once $snipPath."weblogin/weblogin.common.inc.php";
include_once $snipPath."weblogin/websignup.inc.php";

# Return
return $output;';
$s['WebSignupProps'] = '&tpl=Template;string; ';
$s['WebChangePwd'] = '# Created By Raymond Irving April, 2005
#::::::::::::::::::::::::::::::::::::::::
# Params:	
#
#	&tpl			- (Optional)
#		Chunk name or document id to use as a template
#				  
#	Note: Templats design:
#			section 1: change pwd template
#			section 2: notification template 
#
# Examples:
#
#	[[WebChangePwd? &tpl=`ChangePwd`]] 

# Set Snippet Paths 
$snipPath  = (($modx->isBackend())? "../":"");
$snipPath .= "assets/snippets/";

# check if inside manager
if ($m = $modx->isBackend()) {
	return \'\'; # don\'t go any further when inside manager
}


# Snippet customize settings
$tpl		= isset($tpl)? $tpl:"";

# System settings
$isPostBack		= count($_POST) && isset($_POST[\'cmdwebchngpwd\']);

# Start processing
include_once $snipPath."weblogin/weblogin.common.inc.php";
include_once $snipPath."weblogin/webchangepwd.inc.php";

# Return
return $output;



';
$s['WebChangePwd'] = '# Created By Raymond Irving April, 2005
#::::::::::::::::::::::::::::::::::::::::
# Params:	
#
#	&tpl			- (Optional)
#		Chunk name or document id to use as a template
#				  
#	Note: Templats design:
#			section 1: change pwd template
#			section 2: notification template 
#
# Examples:
#
#	[[WebChangePwd? &tpl=`ChangePwd`]] 

# Set Snippet Paths 
$snipPath  = (($modx->isBackend())? "../":"");
$snipPath .= "assets/snippets/";

# check if inside manager
if ($m = $modx->isBackend()) {
	return \'\'; # don\'t go any further when inside manager
}


# Snippet customize settings
$tpl		= isset($tpl)? $tpl:"";

# System settings
$isPostBack		= count($_POST) && isset($_POST[\'cmdwebchngpwd\']);

# Start processing
include_once $snipPath."weblogin/weblogin.common.inc.php";
include_once $snipPath."weblogin/webchangepwd.inc.php";

# Return
return $output;



';
$s['eForm'] = 'return require MODX_BASE_PATH.\'assets/snippets/eform/snippet.eform.php\';';
$s['eForm'] = 'return require MODX_BASE_PATH.\'assets/snippets/eform/snippet.eform.php\';';
$s['Breadcrumbs'] = 'return require MODX_BASE_PATH.\'assets/snippets/breadcrumbs/snippet.breadcrumbs.php\';';
$s['Breadcrumbs'] = 'return require MODX_BASE_PATH.\'assets/snippets/breadcrumbs/snippet.breadcrumbs.php\';';
$s['Jot'] = '/*####
#
# Author: Armand "bS" Pondman (apondman@zerobarrier.nl)
#
# Latest Version: http://modx.com/extras/package/jot
# Jot Demo Site: http://projects.zerobarrier.nl/modx/
# Documentation: http://wiki.modxcms.com/index.php/Jot (wiki)
#
####*/

$jotPath = $modx->config[\'base_path\'] . \'assets/snippets/jot/\';
include_once($jotPath.\'jot.class.inc.php\');

$Jot = new CJot;
$Jot->VersionCheck("1.1.4");
$Jot->Set("path",$jotPath);
$Jot->Set("action", $action);
$Jot->Set("postdelay", $postdelay);
$Jot->Set("docid", $docid);
$Jot->Set("tagid", $tagid);
$Jot->Set("subscribe", $subscribe);
$Jot->Set("moderated", $moderated);
$Jot->Set("captcha", $captcha);
$Jot->Set("badwords", $badwords);
$Jot->Set("bw", $bw);
$Jot->Set("sortby", $sortby);
$Jot->Set("numdir", $numdir);
$Jot->Set("customfields", $customfields);
$Jot->Set("guestname", $guestname);
$Jot->Set("canpost", $canpost);
$Jot->Set("canview", $canview);
$Jot->Set("canedit", $canedit);
$Jot->Set("canmoderate", $canmoderate);
$Jot->Set("trusted", $trusted);
$Jot->Set("pagination", $pagination);
$Jot->Set("placeholders", $placeholders);
$Jot->Set("subjectSubscribe", $subjectSubscribe);
$Jot->Set("subjectModerate", $subjectModerate);
$Jot->Set("subjectAuthor", $subjectAuthor);
$Jot->Set("notify", $notify);
$Jot->Set("notifyAuthor", $notifyAuthor);
$Jot->Set("validate", $validate);
$Jot->Set("title", $title);
$Jot->Set("authorid", $authorid);
$Jot->Set("css", $css);
$Jot->Set("cssFile", $cssFile);
$Jot->Set("cssRowAlt", $cssRowAlt);
$Jot->Set("cssRowMe", $cssRowMe);
$Jot->Set("cssRowAuthor", $cssRowAuthor);
$Jot->Set("tplForm", $tplForm);
$Jot->Set("tplComments", $tplComments);
$Jot->Set("tplModerate", $tplModerate);
$Jot->Set("tplNav", $tplNav);
$Jot->Set("tplNotify", $tplNotify);
$Jot->Set("tplNotifyModerator", $tplNotifyModerator);
$Jot->Set("tplNotifyAuthor", $tplNotifyAuthor);
$Jot->Set("tplSubscribe", $tplSubscribe);
$Jot->Set("debug", $debug);
$Jot->Set("output", $output);
return $Jot->Run();';
$s['Jot'] = '/*####
#
# Author: Armand "bS" Pondman (apondman@zerobarrier.nl)
#
# Latest Version: http://modx.com/extras/package/jot
# Jot Demo Site: http://projects.zerobarrier.nl/modx/
# Documentation: http://wiki.modxcms.com/index.php/Jot (wiki)
#
####*/

$jotPath = $modx->config[\'base_path\'] . \'assets/snippets/jot/\';
include_once($jotPath.\'jot.class.inc.php\');

$Jot = new CJot;
$Jot->VersionCheck("1.1.4");
$Jot->Set("path",$jotPath);
$Jot->Set("action", $action);
$Jot->Set("postdelay", $postdelay);
$Jot->Set("docid", $docid);
$Jot->Set("tagid", $tagid);
$Jot->Set("subscribe", $subscribe);
$Jot->Set("moderated", $moderated);
$Jot->Set("captcha", $captcha);
$Jot->Set("badwords", $badwords);
$Jot->Set("bw", $bw);
$Jot->Set("sortby", $sortby);
$Jot->Set("numdir", $numdir);
$Jot->Set("customfields", $customfields);
$Jot->Set("guestname", $guestname);
$Jot->Set("canpost", $canpost);
$Jot->Set("canview", $canview);
$Jot->Set("canedit", $canedit);
$Jot->Set("canmoderate", $canmoderate);
$Jot->Set("trusted", $trusted);
$Jot->Set("pagination", $pagination);
$Jot->Set("placeholders", $placeholders);
$Jot->Set("subjectSubscribe", $subjectSubscribe);
$Jot->Set("subjectModerate", $subjectModerate);
$Jot->Set("subjectAuthor", $subjectAuthor);
$Jot->Set("notify", $notify);
$Jot->Set("notifyAuthor", $notifyAuthor);
$Jot->Set("validate", $validate);
$Jot->Set("title", $title);
$Jot->Set("authorid", $authorid);
$Jot->Set("css", $css);
$Jot->Set("cssFile", $cssFile);
$Jot->Set("cssRowAlt", $cssRowAlt);
$Jot->Set("cssRowMe", $cssRowMe);
$Jot->Set("cssRowAuthor", $cssRowAuthor);
$Jot->Set("tplForm", $tplForm);
$Jot->Set("tplComments", $tplComments);
$Jot->Set("tplModerate", $tplModerate);
$Jot->Set("tplNav", $tplNav);
$Jot->Set("tplNotify", $tplNotify);
$Jot->Set("tplNotifyModerator", $tplNotifyModerator);
$Jot->Set("tplNotifyAuthor", $tplNotifyAuthor);
$Jot->Set("tplSubscribe", $tplSubscribe);
$Jot->Set("debug", $debug);
$Jot->Set("output", $output);
return $Jot->Run();';
$s['Reflect'] = '/*
 * Author: 
 *      Mark Kaplan for MODX CMF
 * 
 * Note: 
 *      If Reflect is not retrieving its own documents, make sure that the
 *          Ditto call feeding it has all of the fields in it that you plan on
 *       calling in your Reflect template. Furthermore, Reflect will ONLY
 *          show what is currently in the Ditto result set.
 *       Thus, if pagination is on it will ONLY show that page\'s items.
*/
 

// ---------------------------------------------------
//  Includes
// ---------------------------------------------------

$reflect_base = isset($reflect_base) ? $modx->config[\'base_path\'].$reflect_base : $modx->config[\'base_path\']."assets/snippets/reflect/";
/*
    Param: ditto_base
    
    Purpose:
    Location of Ditto files

    Options:
    Any valid folder location containing the Ditto source code with a trailing slash

    Default:
    [(base_path)]assets/snippets/ditto/
*/

$config = (isset($config)) ? $config : "default";
/*
    Param: config

    Purpose:
    Load a custom configuration

    Options:
    "default" - default blank config file
    CONFIG_NAME - Other configs installed in the configs folder or in any folder within the MODX base path via @FILE

    Default:
    "default"
    
    Related:
    - <extenders>
*/

require($reflect_base."configs/default.config.php");
require($reflect_base."default.templates.php");
if ($config != "default") {
    require((substr($config, 0, 5) != "@FILE") ? $reflect_base."configs/$config.config.php" : $modx->config[\'base_path\'].trim(substr($config, 5)));
}

// ---------------------------------------------------
//  Parameters
// ---------------------------------------------------

$id = isset($id) ? $id."_" : false;
/*
    Param: id

    Purpose:
    Unique ID for this Ditto instance for connection with other scripts (like Reflect) and unique URL parameters

    Options:
    Any valid folder location containing the Ditto source code with a trailing slash

    Default:
    "" - blank
*/
$getDocuments = isset($getDocuments) ? $getDocuments : 0;
/*
    Param: getDocuments

    Purpose:
    Force Reflect to get documents

    Options:
    0 - off
    1 - on
    
    Default:
    0 - off
*/
$showItems = isset($showItems) ? $showItems : 1;
/*
    Param: showItems

    Purpose:
    Show individual items in the archive

    Options:
    0 - off
    1 - on
    
    Default:
    1 - on
*/
$groupByYears = isset($groupByYears)? $groupByYears : 1;
/*
    Param: groupByYears

    Purpose:
    Group the archive by years

    Options:
    0 - off
    1 - on
    
    Default:
    1 - on
*/
$targetID = isset($targetID) ? $targetID : $modx->documentObject[\'id\'];
/*
    Param: targetID

    Purpose:
    ID for archive links to point to

    Options:
    Any MODX document with a Ditto call setup with extenders=`dateFilter`
    
    Default:
    Current MODX Document
*/
$dateSource = isset($dateSource) ? $dateSource : "createdon";
/*
    Param: dateSource

    Purpose:
    Date source to display for archive items

    Options:
    # - Any UNIX timestamp from MODX fields or TVs such as createdon, pub_date, or editedon
    
    Default:
    "createdon"
    
    Related:
    - <dateFormat>
*/
$dateFormat = isset($dateFormat) ? $dateFormat : "%d-%b-%y %H:%M";  
/*
    Param: dateFormat

    Purpose:
    Format the [+date+] placeholder in human readable form

    Options:
    Any PHP valid strftime option

    Default:
    "%d-%b-%y %H:%M"
    
    Related:
    - <dateSource>
*/
$yearSortDir = isset($yearSortDir) ? $yearSortDir : "DESC";
/*
    Param: yearSortDir

    Purpose:
    Direction to sort documents

    Options:
    ASC - ascending
    DESC - descending

    Default:
    "DESC"
    
    Related:
    - <monthSortDir>
*/
$monthSortDir = isset($monthSortDir) ? $monthSortDir : "ASC";
/*
    Param: monthSortDir

    Purpose:
    Direction to sort the months

    Options:
    ASC - ascending
    DESC - descending

    Default:
    "ASC"
    
    Related:
    - <yearSortDir>
*/
$start = isset($start)? intval($start) : 0;
/*
    Param: start

    Purpose:
    Number of documents to skip in the results
    
    Options:
    Any number

    Default:
    0
*/  
$phx = (isset($phx))? $phx : 1;
/*
    Param: phx

    Purpose:
    Use PHx formatting

    Options:
    0 - off
    1 - on
    
    Default:
    1 - on
*/

// ---------------------------------------------------
//  Initialize Ditto
// ---------------------------------------------------
$placeholder = ($id != false && $getDocuments == 0) ? true : false;
if ($placeholder === false) {
    $rID = "reflect_".rand(1,1000);
    $itemTemplate = isset($tplItem) ? $tplItem: "@CODE:".$defaultTemplates[\'item\'];
    $dParams = array(
        "id" => "$rID",
        "save" => "3",  
        "summarize" => "all",
        "tpl" => $itemTemplate,
    );
    
    $source = $dittoSnippetName;
    $params = $dittoSnippetParameters;
        // TODO: Remove after 3.0
        
    if (isset($params)) {
        $givenParams = explode("|",$params);
        foreach ($givenParams as $parameter) {
            $p = explode(":",$parameter);
            $dParams[$p[0]] = $p[1];
        }
    }
    /*
        Param: params

        Purpose:
        Pass parameters to the Ditto instance used to retreive the documents

        Options:
        Any valid ditto parameters in the format name:value 
        with multiple parameters separated by a pipe (|)
        
        Note:
        This parameter is only needed for config, start, and phx as you can
        now simply use the parameter as if Reflect was Ditto

        Default:
        [NULL]
    */
    
    $reflectParameters = array(\'reflect_base\',\'config\',\'id\',\'getDocuments\',\'showItems\',\'groupByYears\',\'targetID\',\'yearSortDir\',\'monthSortDir\',\'start\',\'phx\',\'tplContainer\',\'tplYear\',\'tplMonth\',\'tplMonthInner\',\'tplItem\',\'save\');
    $params =& $modx->event->params;
    if(is_array($params)) {
        foreach ($params as $param=>$value) {
            if (!in_array($param,$reflectParameters) && substr($param,-3) != \'tpl\') {
                $dParams[$param] = $value;
            }
        }
    }

    $source = isset($source) ? $source : "Ditto";
    /*
        Param: source

        Purpose:
        Name of the Ditto snippet to use

        Options:
        Any valid snippet name

        Default:
        "Ditto"
    */
    $snippetOutput = $modx->runSnippet($source,$dParams);
    $ditto = $modx->getPlaceholder($rID."_ditto_object");
    $resource = $modx->getPlaceholder($rID."_ditto_resource");
} else {
    $ditto = $modx->getPlaceholder($id."ditto_object");
    $resource = $modx->getPlaceholder($id."ditto_resource");
}
if (!is_object($ditto) || !isset($ditto) || !isset($resource)) {
    return !empty($snippetOutput) ? $snippetOutput : "The Ditto object is invalid. Please check it.";
}

// ---------------------------------------------------
//  Templates
// ---------------------------------------------------

$templates[\'tpl\'] = isset($tplContainer) ? $ditto->template->fetch($tplContainer): $defaultTemplates[\'tpl\'];
/*
    Param: tplContainer

    Purpose:
    Container template for the archive

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'year\'] = isset($tplYear) ? $ditto->template->fetch($tplYear): $defaultTemplates[\'year\'];
/*
    Param: tplYear

    Purpose:
    Template for the year item

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'year_inner\'] = isset($tplYearInner) ? $ditto->template->fetch($tplYearInner): $defaultTemplates[\'year_inner\'];
/*
    Param: tplYearInner

    Purpose:
    Template for the year item (the ul to hold the year template)

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'month\'] = isset($tplMonth) ? $ditto->template->fetch($tplMonth): $defaultTemplates[\'month\'];
/*
    Param: tplMonth

    Purpose:
    Template for the month item

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'month_inner\'] = isset($tplMonthInner) ? $ditto->template->fetch($tplMonthInner): $defaultTemplates[\'month_inner\'];
/*
    Param: tplMonthInner

    Purpose:
    Template for the month item  (the ul to hold the month template)

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'item\'] = isset($tplItem) ? $ditto->template->fetch($tplItem): $defaultTemplates[\'item\'];
/*
    Param: tplItem

    Purpose:
    Template for the individual item

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/

$ditto->addField("date","display","custom");
    // force add the date field if receiving data from a Ditto instance

// ---------------------------------------------------
//  Reflect
// ---------------------------------------------------

if (function_exists("reflect") === FALSE) {
function reflect($templatesDocumentID, $showItems, $groupByYears, $resource, $templatesDateSource, $dateFormat, $ditto, $templates,$id,$start,$yearSortDir,$monthSortDir) {
    global $modx;
    $cal = array();
    $output = \'\';
    $ph = array(\'year\'=>\'\',\'month\'=>\'\',\'item\'=>\'\',\'out\'=>\'\');
    $build = array();
    $stop = count($resource);

    // loop and fetch all the results
    for ($i = $start; $i < $stop; $i++) {
        $date = getdate($resource[$i][$templatesDateSource]);
        $year = $date["year"];
        $month = $date["mon"];
        $cal[$year][$month][] = $resource[$i];
    }
    if ($yearSortDir == "DESC") {
        krsort($cal);
    } else {
        ksort($cal);
    }
    foreach ($cal as $year=>$months) {
        if ($monthSortDir == "ASC") {
            ksort($months);
        } else {
            krsort($months);
        }
        $build[$year] = $months;
    }
    
    foreach ($build as $year=>$months) {
        $r_year = \'\';
        $r_month = \'\';
        $r_month_2 = \'\';
        $year_count = 0;
        $items = array();
        
        foreach ($months as $mon=>$month) {
            $month_text = strftime("%B", mktime(10, 10, 10, $mon, 10, $year));
            $month_url = $ditto->buildURL("month=".$mon."&year=".$year."&day=false&start=0",$templatesDocumentID,$id);
            $month_count = count($month);
            $year_count += $month_count;
            $r_month = $ditto->template->replace(array("year"=>$year,"month"=>$month_text,"url"=>$month_url,"count"=>$month_count),$templates[\'month\']);
            if ($showItems) {
                foreach ($month as $item) {
                    $items[$year][$mon][\'items\'][] = $ditto->render($item, $templates[\'item\'], false, $templatesDateSource, $dateFormat, array(),$phx);
                }
                $r_month_2 = $ditto->template->replace(array(\'wrapper\' => implode(\'\',$items[$year][$mon][\'items\'])),$templates[\'month_inner\']);
                $items[$year][$mon] = $ditto->template->replace(array(\'wrapper\' => $r_month_2),$r_month);
            } else {
                $items[$year][$mon] = $r_month;
            }
        }
        if ($groupByYears) {
            $year_url = $ditto->buildURL("year=".$year."&month=false&day=false&start=0",$templatesDocumentID,$id);
            $r_year =  $ditto->template->replace(array("year"=>$year,"url"=>$year_url,"count"=>$year_count),$templates[\'year\']);
            $var = $ditto->template->replace(array(\'wrapper\'=>implode(\'\',$items[$year])),$templates[\'year_inner\']);
            $output .= $ditto->template->replace(array(\'wrapper\'=>$var),$r_year);
        } else {
            $output .= implode(\'\',$items[$year]);
        }
    }

    $output = $ditto->template->replace(array(\'wrapper\'=>$output),$templates[\'tpl\']);
    $modx->setPlaceholder($id.\'reset\',$ditto->buildURL(\'year=false&month=false&day=false\',$templatesDocumentID,$id));

return $output;
    
}
}

return reflect($targetID, $showItems, $groupByYears, $resource, $dateSource, $dateFormat, $ditto, $templates,$id,$start,$yearSortDir,$monthSortDir);';
$s['Reflect'] = '/*
 * Author: 
 *      Mark Kaplan for MODX CMF
 * 
 * Note: 
 *      If Reflect is not retrieving its own documents, make sure that the
 *          Ditto call feeding it has all of the fields in it that you plan on
 *       calling in your Reflect template. Furthermore, Reflect will ONLY
 *          show what is currently in the Ditto result set.
 *       Thus, if pagination is on it will ONLY show that page\'s items.
*/
 

// ---------------------------------------------------
//  Includes
// ---------------------------------------------------

$reflect_base = isset($reflect_base) ? $modx->config[\'base_path\'].$reflect_base : $modx->config[\'base_path\']."assets/snippets/reflect/";
/*
    Param: ditto_base
    
    Purpose:
    Location of Ditto files

    Options:
    Any valid folder location containing the Ditto source code with a trailing slash

    Default:
    [(base_path)]assets/snippets/ditto/
*/

$config = (isset($config)) ? $config : "default";
/*
    Param: config

    Purpose:
    Load a custom configuration

    Options:
    "default" - default blank config file
    CONFIG_NAME - Other configs installed in the configs folder or in any folder within the MODX base path via @FILE

    Default:
    "default"
    
    Related:
    - <extenders>
*/

require($reflect_base."configs/default.config.php");
require($reflect_base."default.templates.php");
if ($config != "default") {
    require((substr($config, 0, 5) != "@FILE") ? $reflect_base."configs/$config.config.php" : $modx->config[\'base_path\'].trim(substr($config, 5)));
}

// ---------------------------------------------------
//  Parameters
// ---------------------------------------------------

$id = isset($id) ? $id."_" : false;
/*
    Param: id

    Purpose:
    Unique ID for this Ditto instance for connection with other scripts (like Reflect) and unique URL parameters

    Options:
    Any valid folder location containing the Ditto source code with a trailing slash

    Default:
    "" - blank
*/
$getDocuments = isset($getDocuments) ? $getDocuments : 0;
/*
    Param: getDocuments

    Purpose:
    Force Reflect to get documents

    Options:
    0 - off
    1 - on
    
    Default:
    0 - off
*/
$showItems = isset($showItems) ? $showItems : 1;
/*
    Param: showItems

    Purpose:
    Show individual items in the archive

    Options:
    0 - off
    1 - on
    
    Default:
    1 - on
*/
$groupByYears = isset($groupByYears)? $groupByYears : 1;
/*
    Param: groupByYears

    Purpose:
    Group the archive by years

    Options:
    0 - off
    1 - on
    
    Default:
    1 - on
*/
$targetID = isset($targetID) ? $targetID : $modx->documentObject[\'id\'];
/*
    Param: targetID

    Purpose:
    ID for archive links to point to

    Options:
    Any MODX document with a Ditto call setup with extenders=`dateFilter`
    
    Default:
    Current MODX Document
*/
$dateSource = isset($dateSource) ? $dateSource : "createdon";
/*
    Param: dateSource

    Purpose:
    Date source to display for archive items

    Options:
    # - Any UNIX timestamp from MODX fields or TVs such as createdon, pub_date, or editedon
    
    Default:
    "createdon"
    
    Related:
    - <dateFormat>
*/
$dateFormat = isset($dateFormat) ? $dateFormat : "%d-%b-%y %H:%M";  
/*
    Param: dateFormat

    Purpose:
    Format the [+date+] placeholder in human readable form

    Options:
    Any PHP valid strftime option

    Default:
    "%d-%b-%y %H:%M"
    
    Related:
    - <dateSource>
*/
$yearSortDir = isset($yearSortDir) ? $yearSortDir : "DESC";
/*
    Param: yearSortDir

    Purpose:
    Direction to sort documents

    Options:
    ASC - ascending
    DESC - descending

    Default:
    "DESC"
    
    Related:
    - <monthSortDir>
*/
$monthSortDir = isset($monthSortDir) ? $monthSortDir : "ASC";
/*
    Param: monthSortDir

    Purpose:
    Direction to sort the months

    Options:
    ASC - ascending
    DESC - descending

    Default:
    "ASC"
    
    Related:
    - <yearSortDir>
*/
$start = isset($start)? intval($start) : 0;
/*
    Param: start

    Purpose:
    Number of documents to skip in the results
    
    Options:
    Any number

    Default:
    0
*/  
$phx = (isset($phx))? $phx : 1;
/*
    Param: phx

    Purpose:
    Use PHx formatting

    Options:
    0 - off
    1 - on
    
    Default:
    1 - on
*/

// ---------------------------------------------------
//  Initialize Ditto
// ---------------------------------------------------
$placeholder = ($id != false && $getDocuments == 0) ? true : false;
if ($placeholder === false) {
    $rID = "reflect_".rand(1,1000);
    $itemTemplate = isset($tplItem) ? $tplItem: "@CODE:".$defaultTemplates[\'item\'];
    $dParams = array(
        "id" => "$rID",
        "save" => "3",  
        "summarize" => "all",
        "tpl" => $itemTemplate,
    );
    
    $source = $dittoSnippetName;
    $params = $dittoSnippetParameters;
        // TODO: Remove after 3.0
        
    if (isset($params)) {
        $givenParams = explode("|",$params);
        foreach ($givenParams as $parameter) {
            $p = explode(":",$parameter);
            $dParams[$p[0]] = $p[1];
        }
    }
    /*
        Param: params

        Purpose:
        Pass parameters to the Ditto instance used to retreive the documents

        Options:
        Any valid ditto parameters in the format name:value 
        with multiple parameters separated by a pipe (|)
        
        Note:
        This parameter is only needed for config, start, and phx as you can
        now simply use the parameter as if Reflect was Ditto

        Default:
        [NULL]
    */
    
    $reflectParameters = array(\'reflect_base\',\'config\',\'id\',\'getDocuments\',\'showItems\',\'groupByYears\',\'targetID\',\'yearSortDir\',\'monthSortDir\',\'start\',\'phx\',\'tplContainer\',\'tplYear\',\'tplMonth\',\'tplMonthInner\',\'tplItem\',\'save\');
    $params =& $modx->event->params;
    if(is_array($params)) {
        foreach ($params as $param=>$value) {
            if (!in_array($param,$reflectParameters) && substr($param,-3) != \'tpl\') {
                $dParams[$param] = $value;
            }
        }
    }

    $source = isset($source) ? $source : "Ditto";
    /*
        Param: source

        Purpose:
        Name of the Ditto snippet to use

        Options:
        Any valid snippet name

        Default:
        "Ditto"
    */
    $snippetOutput = $modx->runSnippet($source,$dParams);
    $ditto = $modx->getPlaceholder($rID."_ditto_object");
    $resource = $modx->getPlaceholder($rID."_ditto_resource");
} else {
    $ditto = $modx->getPlaceholder($id."ditto_object");
    $resource = $modx->getPlaceholder($id."ditto_resource");
}
if (!is_object($ditto) || !isset($ditto) || !isset($resource)) {
    return !empty($snippetOutput) ? $snippetOutput : "The Ditto object is invalid. Please check it.";
}

// ---------------------------------------------------
//  Templates
// ---------------------------------------------------

$templates[\'tpl\'] = isset($tplContainer) ? $ditto->template->fetch($tplContainer): $defaultTemplates[\'tpl\'];
/*
    Param: tplContainer

    Purpose:
    Container template for the archive

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'year\'] = isset($tplYear) ? $ditto->template->fetch($tplYear): $defaultTemplates[\'year\'];
/*
    Param: tplYear

    Purpose:
    Template for the year item

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'year_inner\'] = isset($tplYearInner) ? $ditto->template->fetch($tplYearInner): $defaultTemplates[\'year_inner\'];
/*
    Param: tplYearInner

    Purpose:
    Template for the year item (the ul to hold the year template)

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'month\'] = isset($tplMonth) ? $ditto->template->fetch($tplMonth): $defaultTemplates[\'month\'];
/*
    Param: tplMonth

    Purpose:
    Template for the month item

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'month_inner\'] = isset($tplMonthInner) ? $ditto->template->fetch($tplMonthInner): $defaultTemplates[\'month_inner\'];
/*
    Param: tplMonthInner

    Purpose:
    Template for the month item  (the ul to hold the month template)

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/
$templates[\'item\'] = isset($tplItem) ? $ditto->template->fetch($tplItem): $defaultTemplates[\'item\'];
/*
    Param: tplItem

    Purpose:
    Template for the individual item

    Options:
    - Any valid chunk name
    - Code via @CODE:
    - File via @FILE:

    Default:
    See default.tempates.php
*/

$ditto->addField("date","display","custom");
    // force add the date field if receiving data from a Ditto instance

// ---------------------------------------------------
//  Reflect
// ---------------------------------------------------

if (function_exists("reflect") === FALSE) {
function reflect($templatesDocumentID, $showItems, $groupByYears, $resource, $templatesDateSource, $dateFormat, $ditto, $templates,$id,$start,$yearSortDir,$monthSortDir) {
    global $modx;
    $cal = array();
    $output = \'\';
    $ph = array(\'year\'=>\'\',\'month\'=>\'\',\'item\'=>\'\',\'out\'=>\'\');
    $build = array();
    $stop = count($resource);

    // loop and fetch all the results
    for ($i = $start; $i < $stop; $i++) {
        $date = getdate($resource[$i][$templatesDateSource]);
        $year = $date["year"];
        $month = $date["mon"];
        $cal[$year][$month][] = $resource[$i];
    }
    if ($yearSortDir == "DESC") {
        krsort($cal);
    } else {
        ksort($cal);
    }
    foreach ($cal as $year=>$months) {
        if ($monthSortDir == "ASC") {
            ksort($months);
        } else {
            krsort($months);
        }
        $build[$year] = $months;
    }
    
    foreach ($build as $year=>$months) {
        $r_year = \'\';
        $r_month = \'\';
        $r_month_2 = \'\';
        $year_count = 0;
        $items = array();
        
        foreach ($months as $mon=>$month) {
            $month_text = strftime("%B", mktime(10, 10, 10, $mon, 10, $year));
            $month_url = $ditto->buildURL("month=".$mon."&year=".$year."&day=false&start=0",$templatesDocumentID,$id);
            $month_count = count($month);
            $year_count += $month_count;
            $r_month = $ditto->template->replace(array("year"=>$year,"month"=>$month_text,"url"=>$month_url,"count"=>$month_count),$templates[\'month\']);
            if ($showItems) {
                foreach ($month as $item) {
                    $items[$year][$mon][\'items\'][] = $ditto->render($item, $templates[\'item\'], false, $templatesDateSource, $dateFormat, array(),$phx);
                }
                $r_month_2 = $ditto->template->replace(array(\'wrapper\' => implode(\'\',$items[$year][$mon][\'items\'])),$templates[\'month_inner\']);
                $items[$year][$mon] = $ditto->template->replace(array(\'wrapper\' => $r_month_2),$r_month);
            } else {
                $items[$year][$mon] = $r_month;
            }
        }
        if ($groupByYears) {
            $year_url = $ditto->buildURL("year=".$year."&month=false&day=false&start=0",$templatesDocumentID,$id);
            $r_year =  $ditto->template->replace(array("year"=>$year,"url"=>$year_url,"count"=>$year_count),$templates[\'year\']);
            $var = $ditto->template->replace(array(\'wrapper\'=>implode(\'\',$items[$year])),$templates[\'year_inner\']);
            $output .= $ditto->template->replace(array(\'wrapper\'=>$var),$r_year);
        } else {
            $output .= implode(\'\',$items[$year]);
        }
    }

    $output = $ditto->template->replace(array(\'wrapper\'=>$output),$templates[\'tpl\']);
    $modx->setPlaceholder($id.\'reset\',$ditto->buildURL(\'year=false&month=false&day=false\',$templatesDocumentID,$id));

return $output;
    
}
}

return reflect($targetID, $showItems, $groupByYears, $resource, $dateSource, $dateFormat, $ditto, $templates,$id,$start,$yearSortDir,$monthSortDir);';
$s['Ditto'] = 'return require MODX_BASE_PATH.\'assets/snippets/ditto/snippet.ditto.php\';';
$s['Ditto'] = 'return require MODX_BASE_PATH.\'assets/snippets/ditto/snippet.ditto.php\';';
$s['ListIndexer'] = 'return require MODX_BASE_PATH.\'assets/snippets/listindexer/snippet.listindexer.php\';';
$s['ListIndexer'] = 'return require MODX_BASE_PATH.\'assets/snippets/listindexer/snippet.listindexer.php\';';
$s['WebLogin'] = '# Created By Raymond Irving 2004
#::::::::::::::::::::::::::::::::::::::::
# Params:	
#
#	&loginhomeid 	- (Optional)
#		redirects the user to first authorized page in the list.
#		If no id was specified then the login home page id or 
#		the current document id will be used
#
#	&logouthomeid 	- (Optional)
#		document id to load when user logs out	
#
#	&pwdreqid 	- (Optional)
#		document id to load after the user has submited
#		a request for a new password
#
#	&pwdactid 	- (Optional)
#		document id to load when the after the user has activated
#		their new password
#
#	&logintext		- (Optional) 
#		Text to be displayed inside login button (for built-in form)
#
#	&logouttext 	- (Optional)
#		Text to be displayed inside logout link (for built-in form)
#	
#	&tpl			- (Optional)
#		Chunk name or document id to as a template
#				  
#	Note: Templats design:
#			section 1: login template
#			section 2: logout template 
#			section 3: password reminder template 
#
#			See weblogin.tpl for more information
#
# Examples:
#
#	[[WebLogin? &loginhomeid=`8` &logouthomeid=`1`]] 
#
#	[[WebLogin? &loginhomeid=`8,18,7,5` &tpl=`Login`]] 

# Set Snippet Paths 
$snipPath = $modx->config[\'base_path\'] . "assets/snippets/";

# check if inside manager
if ($m = $modx->isBackend()) {
	return \'\'; # don\'t go any further when inside manager
}

# deprecated params - only for backward compatibility
if(isset($loginid)) $loginhomeid=$loginid;
if(isset($logoutid)) $logouthomeid = $logoutid;
if(isset($template)) $tpl = $template;

# Snippet customize settings
$liHomeId	= isset($loginhomeid)? array_filter(array_map(\'intval\', explode(\',\', $loginhomeid))):array($modx->config[\'login_home\'],$modx->documentIdentifier);
$loHomeId	= isset($logouthomeid)? $logouthomeid:$modx->documentIdentifier;
$pwdReqId	= isset($pwdreqid)? $pwdreqid:0;
$pwdActId	= isset($pwdactid)? $pwdactid:0;
$loginText	= isset($logintext)? $logintext:\'Login\';
$logoutText	= isset($logouttext)? $logouttext:\'Logout\';
$tpl		= isset($tpl)? $tpl:"";

# System settings
$webLoginMode = isset($_REQUEST[\'webloginmode\'])? $_REQUEST[\'webloginmode\']: \'\';
$isLogOut		= $webLoginMode==\'lo\' ? 1:0;
$isPWDActivate	= $webLoginMode==\'actp\' ? 1:0;
$isPostBack		= count($_POST) && (isset($_POST[\'cmdweblogin\']) || isset($_POST[\'cmdweblogin_x\']));
$txtPwdRem 		= isset($_REQUEST[\'txtpwdrem\'])? $_REQUEST[\'txtpwdrem\']: 0;
$isPWDReminder	= $isPostBack && $txtPwdRem==\'1\' ? 1:0;

$site_id = isset($site_id)? $site_id: \'\';
$cookieKey = substr(md5($site_id."Web-User"),0,15);

# Start processing
include_once $snipPath."weblogin/weblogin.common.inc.php";
include_once ($modx->config[\'site_manager_path\'] . "includes/crypt.class.inc.php");

if ($isPWDActivate || $isPWDReminder || $isLogOut || $isPostBack) {
	# include the logger class
	include_once $modx->config[\'site_manager_path\'] . "includes/log.class.inc.php";
	include_once $snipPath."weblogin/weblogin.processor.inc.php";
}

include_once $snipPath."weblogin/weblogin.inc.php";

# Return
return $output;
';
$s['WebLoginProps'] = '&loginhomeid=Login Home Id;string; &logouthomeid=Logout Home Id;string; &logintext=Login Button Text;string; &logouttext=Logout Button Text;string; &tpl=Template;string; ';
$s['WebLogin'] = '# Created By Raymond Irving 2004
#::::::::::::::::::::::::::::::::::::::::
# Params:	
#
#	&loginhomeid 	- (Optional)
#		redirects the user to first authorized page in the list.
#		If no id was specified then the login home page id or 
#		the current document id will be used
#
#	&logouthomeid 	- (Optional)
#		document id to load when user logs out	
#
#	&pwdreqid 	- (Optional)
#		document id to load after the user has submited
#		a request for a new password
#
#	&pwdactid 	- (Optional)
#		document id to load when the after the user has activated
#		their new password
#
#	&logintext		- (Optional) 
#		Text to be displayed inside login button (for built-in form)
#
#	&logouttext 	- (Optional)
#		Text to be displayed inside logout link (for built-in form)
#	
#	&tpl			- (Optional)
#		Chunk name or document id to as a template
#				  
#	Note: Templats design:
#			section 1: login template
#			section 2: logout template 
#			section 3: password reminder template 
#
#			See weblogin.tpl for more information
#
# Examples:
#
#	[[WebLogin? &loginhomeid=`8` &logouthomeid=`1`]] 
#
#	[[WebLogin? &loginhomeid=`8,18,7,5` &tpl=`Login`]] 

# Set Snippet Paths 
$snipPath = $modx->config[\'base_path\'] . "assets/snippets/";

# check if inside manager
if ($m = $modx->isBackend()) {
	return \'\'; # don\'t go any further when inside manager
}

# deprecated params - only for backward compatibility
if(isset($loginid)) $loginhomeid=$loginid;
if(isset($logoutid)) $logouthomeid = $logoutid;
if(isset($template)) $tpl = $template;

# Snippet customize settings
$liHomeId	= isset($loginhomeid)? array_filter(array_map(\'intval\', explode(\',\', $loginhomeid))):array($modx->config[\'login_home\'],$modx->documentIdentifier);
$loHomeId	= isset($logouthomeid)? $logouthomeid:$modx->documentIdentifier;
$pwdReqId	= isset($pwdreqid)? $pwdreqid:0;
$pwdActId	= isset($pwdactid)? $pwdactid:0;
$loginText	= isset($logintext)? $logintext:\'Login\';
$logoutText	= isset($logouttext)? $logouttext:\'Logout\';
$tpl		= isset($tpl)? $tpl:"";

# System settings
$webLoginMode = isset($_REQUEST[\'webloginmode\'])? $_REQUEST[\'webloginmode\']: \'\';
$isLogOut		= $webLoginMode==\'lo\' ? 1:0;
$isPWDActivate	= $webLoginMode==\'actp\' ? 1:0;
$isPostBack		= count($_POST) && (isset($_POST[\'cmdweblogin\']) || isset($_POST[\'cmdweblogin_x\']));
$txtPwdRem 		= isset($_REQUEST[\'txtpwdrem\'])? $_REQUEST[\'txtpwdrem\']: 0;
$isPWDReminder	= $isPostBack && $txtPwdRem==\'1\' ? 1:0;

$site_id = isset($site_id)? $site_id: \'\';
$cookieKey = substr(md5($site_id."Web-User"),0,15);

# Start processing
include_once $snipPath."weblogin/weblogin.common.inc.php";
include_once ($modx->config[\'site_manager_path\'] . "includes/crypt.class.inc.php");

if ($isPWDActivate || $isPWDReminder || $isLogOut || $isPostBack) {
	# include the logger class
	include_once $modx->config[\'site_manager_path\'] . "includes/log.class.inc.php";
	include_once $snipPath."weblogin/weblogin.processor.inc.php";
}

include_once $snipPath."weblogin/weblogin.inc.php";

# Return
return $output;
';
$s['WebLoginProps'] = '&loginhomeid=Login Home Id;string; &logouthomeid=Logout Home Id;string; &logintext=Login Button Text;string; &logouttext=Logout Button Text;string; &tpl=Template;string; ';
$s['Personalize'] = 'return require MODX_BASE_PATH.\'assets/snippets/personalize/snippet.personalize.php\';';
$s['Personalize'] = 'return require MODX_BASE_PATH.\'assets/snippets/personalize/snippet.personalize.php\';';
$s['UltimateParent'] = 'return require MODX_BASE_PATH.\'assets/snippets/ultimateparent/snippet.ultimateparent.php\';';
$s['UltimateParent'] = 'return require MODX_BASE_PATH.\'assets/snippets/ultimateparent/snippet.ultimateparent.php\';';
$s['phpthumb'] = 'return require MODX_BASE_PATH.\'assets/snippets/phpthumb/snippet.phpthumb.php\';
';
$s['phpthumb'] = 'return require MODX_BASE_PATH.\'assets/snippets/phpthumb/snippet.phpthumb.php\';
';
$s['snippet'] = '
$res = \'\';
	switch($get){
		
		//form table with user\'s order of tours
		case "user_tours":
			$data = $modx->db->makeArray($modx->db->query(
				"SELECT 
					(SELECT title
						FROM modx_a_alantur_tours
							WHERE id=t.tour_id)
					AS title, 
					(SELECT path
						FROM modx_a_alantur_tours
							WHERE id=t.tour_id)
					AS path, status
					FROM modx_a_alantur_tours_sale t
					WHERE 
						user_id = \'".$_SESSION[\'webuser\'][\'internalKey\']."\'"));
			if(!empty($data)){
				$res .= $modx->parseChunk($tpl_header,array("title" =>"Ваши заказы"));
				foreach($data as $tour){
						$tour[\'status_word\'] = $modx->runSnippet("snippet",array("get" =>"status", "status" => $tour[\'status\']));
						$res .= $modx->parseChunk($tpl, $tour);
				}
			}else
				echo "У Вас пока нет заказов";
		break;
	
		
		//transform number of status to human readible
		case "status":
			switch ($status){
				case 1:
				$status = "Новый заказ тура";
				break;
				case 2:
				$status = "Заказ тура находится в обработке";
				break;
				case 3:
				$status = "Заказчику отослан счет, ждем оплаты";
				break;
				case 4:
				$status = "Заказ тура отменен";
				break;
				default:
				$status = "Ошибка";
				break;
			}
			return $status;
		break;
		
		case "user_balance":
			$res = $modx->db->getValue($modx->db->query(
				"SELECT SUM(balance)
					FROM `modx_a_alantur_balance`
					WHERE user_id=\'".$_SESSION[\'webuser\'][\'internalKey\']."\'"));
			
		break;
		
		// form information for one tour page
		case "one_tour":
				$html = "";
				//prepare all tour\'s images to showing
				$data[\'test\'] = $modx->getPageInfo($modx->db->escape($_GET[\'country\']));
				$country = $data[\'test\'][\'pagetitle\'];	
				$res = array( \'title\'=>$modx->db->escape($_GET[\'title\']),
								\'id\'=>$modx->db->escape($_GET[\'id\']),
								\'description\'=>$modx->db->escape($_GET [\'description\']),
								\'main_image\'=>$modx->db->escape($_GET[\'cover\']),
								\'country_name\'=>$country,
								\'country_id\'=>$modx->db->escape($_GET[\'country\']),
								\'type\'=>$modx->db->escape($_GET[\'type\']),
							 	\'price\' => $modx->db->escape($_GET[\'price\'])
							);
		break;
		
		// snippet for sending email
		case "sendmail":
			if (!class_exists(\'PHPMailer\')) {
					  require MODX_BASE_PATH."manager/includes/controls/phpmailer/class.phpmailer.php";
				  }
				  $Password = $modx->config[\'smtppw\'];
				  $Password = substr($Password,0,-7);
				  $Password = str_replace(\'%\',\'=\',$Password);
				  $Password = base64_decode($Password);
				  $mail = new PHPMailer();
				  $mail->IsSMTP();
				  $mail->SMTPDebug  = 0;
				  $mail->SMTPAuth  = true; 
				  $mail->Host      = $modx->config[\'smtp_host\'];
				  $mail->Port      = $modx->config[\'smtp_port\'];
				  $mail->Username  = $modx->config[\'smtp_username\'];
				  $mail->Password  = $Password;
				  $mail->Subject    = $subject;
				$mail->SetFrom($modx->config[\'smtp_username\'], \'Alantur\');
				  $mail->AddAddress($to);
				  $mail->MsgHTML($body);
			$mail->Send();
			break;
		
		//calc quantity of reports for country;
		case "quantity_reports":
			$sql = "SELECT COUNT(*) 
					FROM `modx_a_alantur_orders`
					WHERE
					`id_country` = \'".$country_id."\'";
			$data_query = $modx->db->query($sql);
			$quantity = $modx->db->getRow($data_query);
			$res = $quantity[\'COUNT(*)\'];
		break;
		
		//insert all images of tour
		case "images":
			$images = "";
			$path = MODX_BASE_PATH.\'assets/images/\'.$modx->db->escape($modx->documentObject[\'id\'])."/*";
			$folder = glob($path);
			foreach($folder as $file){
				$res .= $modx->parseChunk($tpl, array("image" => str_replace(MODX_BASE_PATH,"/",$file)));
			}
		break;	
		
		// show page with current tour	
		case "type_one_tour":
			$res = "";
				foreach($_GET["type"] as $type){
					$d[\'test\'] = $modx->getPageInfo($type);	
					$res .= $modx->parseChunk($tpl, array(\'type_title\' => $d[\'test\'][\'pagetitle\'],
														  \'type_id\' => $type
														 )
											 );	
			}
		break;
		
		// show all reports of all users
		case "All_reports_all_users":	
			$res = "";
			if($sort > 0) $sort = "AND id_country = \'".$sort."\'";
				$data_query = $modx->db->query("SELECT * 
													FROM modx_a_alantur_orders 
													WHERE 
														showing = 2 ".$sort." 
													ORDER BY average
													DESC
													LIMIT 12"
											  );
			while ($data = $modx->db->getRow($data_query)){
					$d = $modx->getPageInfo($data[\'id_country\']);	
					$res .= $modx->runSnippet("snippet",array("get" => "all_report",
															  "tpl" => $tpl, 
															  "tpl_no_photo_noauth" => $tpl_no_photo_noauth,
															  "title" => $d[\'pagetitle\'],
															  "id" => $data[\'id_order\']
															 ) 
											 );
			}
		break;		
		
		// show all user\'s order
		case "orders":	
			$res = "";
			if(!isset($_SESSION[\'webuser\'][\'internalKey\']))
				die("Чтобы просмотреть свои отчеты, Вам необходимо авторизироваться");
			$data_query = $modx->db->query("SELECT * 
												FROM modx_a_alantur_orders
												WHERE 
													id_author = \'".$_SESSION[\'webuser\'][\'internalKey\']."\'");
			while ($data = $modx->db->getRow($data_query)){
				$d = $modx->getPageInfo($data[\'id_country\']);
				switch($data[\'showing\']){
					case 0:
						$mod = "Отчет сохранен, но не отправлен на модерацию";
					break;
					case 1:
						$mod = "Модерации еще не было";
					break;
					case 2:
						$mod = "Отчет одобрен и размещен";
					break;
					case 3:
						$mod = "Отчет отклонен";
					break;
				}
				$res .= $modx->runSnippet("snippet",array("get" => "all_report",
														  "tpl" => $tpl,
														  "tpl_no_photo_edit" => $tpl_no_photo_edit,
														  "title" => $d[\'pagetitle\'],
														  "id" => $data[\'id_order\'],
														  "moderation" => $mod
														 ) 
										 );
			}
		break;
		
		//show each order
		case "give_report":
			$sum = "";
			if($_GET["report"])
				$id = $_GET["report"];
			$id_country = $modx->db->getRow($modx->db->query("SELECT id_country
																FROM modx_a_alantur_orders 
																WHERE 
																	id_order = \'".$modx->db->escape($id)."\'"
															)
										   );
			$d = $modx->getPageInfo($id_country[\'id_country\']);	
			$data_query = $modx->db->query("SELECT *
												FROM modx_a_alantur_orders_detail
												WHERE 
													id_order = \'".$modx->db->escape($id)."\'"
										  );
			while ($data = $modx->db->getRow($data_query)){
				$res .= $modx->parseChunk($tpl, array("country" => $d[\'pagetitle\'],
													 "id_order" => $data[\'id_order\'],
													 "photo_name" => $data[\'photo_name\'],
													 "id_photo" => $data[\'id_photo\'],
													 "description" => $data[\'description\']
													)
										);
			}
		break;	
		
		
		
		//return value of get
		case "get1":
			$res = $_GET[\'report\'];
		break;
		
		//return value of search
		case "get_search":
			$res = $_GET[\'search\'];
		break;
		
		
		
		//show photo of report
		
		case "all_report":
			$rate = $modx->db->getValue($modx->db->query("SELECT AVG(rate) 
															FROM modx_a_alantur_orders_voting 
															WHERE 
																id_report = \'".$id."\'"
														)
									   );
			$data = $modx->db->getRow($modx->db->query("SELECT * 
															FROM modx_a_alantur_orders_detail 
															WHERE
																id_order = \'".$id."\'"
													  )
									 );
			if($data)
				$res .= $modx->parseChunk($tpl, array("title" => $title,
													 "id_order" => $data[\'id_order\'],
													 "photo_name" => $data[\'photo_name\'],
													 "description" => $data[\'description\'], 
													 "rate" => $rate,
													 "moderation" => $moderation
													)
										);
			else $res .= $modx->parseChunk($tpl_no_photo_edit, array("title" => $title,
																	 "id_order" => $id,
																	 "moderation" => $moderation
																	)
										  );
		break;
		
		
		
		//fill user datum to the form in privat page
		case "fill_user_datum":
			$data = $modx->db->getRow($modx->db->query("SELECT username 
															FROM modx_web_users
															WHERE 
																id = \'".$_SESSION[\'webuser\'][\'internalKey\']."\'"
													 )
									);
			if(is_array($modx->documentObject))
				$modx->documentObject = array_merge($modx->documentObject, $data);
			else 
				$modx->documentObject = $data;
			$data = $modx->db->getRow($modx->db->query("SELECT fullname, email 
															FROM modx_web_user_attributes
															WHERE 
																id = \'".$_SESSION[\'webuser\'][\'internalKey\']."\'"
													 )
									);
			$modx->documentObject = array_merge($modx->documentObject, $data);
		break;
		
		
		
		case "get_country":
			$id_country = $modx->db->getRow($modx->db->query("SELECT id_country
																FROM modx_a_alantur_orders 
																WHERE 
																	id_order = \'".$modx->db->escape($_GET["report"])."\'"
														  )
										 );
			$d = $modx->getPageInfo($id_country[\'id_country\']);	
			$res = $d[\'pagetitle\'];
		break;
	}
	return $res;
';
$s['R'] = '
/*
    Сниппет создания миниатюр
*/
    $replace   = Array("," => "&", "_" => "=");
    $options   = strtr($opt, $replace);
    $ext 	   = "jpg";
    $filename  = md5($img.$opt);

    require_once MODX_BASE_PATH . "assets/snippets/phpthumb/phpthumb.class.php";
    $phpThumb = new phpthumb();
    $phpThumb->setSourceFilename($img); 
    $options  = explode("&", $options);
    foreach ($options as $value) {
      $thumb = explode("=", $value);
      $phpThumb->setParameter($thumb[0], $thumb[1]);
	  if ($thumb[0] == "f") $ext = $thumb[1];
    }
    $outputFilename = MODX_BASE_PATH."assets/cache/images/".$filename.".".$ext;
    if (!file_exists($outputFilename))
		if ($phpThumb->GenerateThumbnail())  {
           $phpThumb->RenderToFile($outputFilename);
		   if (file_exists($outputFilename)) chmod($outputFilename, 0777);
		} 
    $res = explode("/assets", $outputFilename); 
    $res = "/assets".$res[1];
    return $res;
';
$s['tours'] = '
if($_GET[\'nextpage\']<2)
			$min = 0;
	else 
		$min = ($modx->db->escape($_GET[\'nextpage\'])-1)*12;
	$data_query = $modx->db->query("SELECT SQL_CALC_FOUND_ROWS * 
										FROM `modx_a_alantur_tours` ".$showing."
										LIMIT ".$min.", 12");
	while ($data = $modx->db->getRow($data_query)) {
		$data[\'image\'] = "/assets/images/".$data[\'id\']."/".$data[\'cover\'];	
		$data[\'reports\'] = $modx->runSnippet("snippet",array("get" => "quantity_reports",
															   "country_id" => $data[\'country\']
															  )
											  );
		$data[\'test\'] = $modx->getPageInfo($data[\'country\']);
		$data[\'country\'] = $data[\'test\'][\'pagetitle\'];
		$res .= $modx->parseChunk($tpl, $data);
	}
	$count = $modx->db->getRow($modx->db->query("SELECT FOUND_ROWS() AS \'count\'"));
	$modx->setPlaceholder("page", $count[\'count\']);
return $res;
';
$s['paging'] = '
	$ser = "";
	$count = $modx->getPlaceholder("page");
	$pages = ceil ($count / 12);
	if($pages>1){ 
		if(isset($_GET[\'nextpage\']))
			echo "<a href=\'/tours\'>1</a>";
		else
			echo "1";
	}
	$i = 2;
	while($i < $pages + 1) {
		if(($pages > 5  and $i < ((int)$_GET[\'nextpage\']-2)) or ($pages > 5 and $i > ((int)$_GET[\'nextpage\']+2))){
			$ser .= ".";
		}
		elseif($i == (int)$_GET[\'nextpage\']){
			//Is this number of active page?
			$ser .= $modx->parseChunk($tpl2, array(\'page\' => $i));
		}else{
			$ser .= $modx->parseChunk($tpl, array(\'page\'=>$i));
		}
	$i++;
	}
	return $ser;
';
$s['filter_type'] = '
//catch number of page
	if($modx->db->escape($_GET[\'nextpage\']) < 2)
		$min = 0;
	else 
		$min=($modx->db->escape($_GET[\'nextpage\'])-1)*12;
	//form filter
	$filter = "";
	$filter_type = ""; 
	//check filter datum for "search"
	if (!empty($_GET[\'search\'])) 
		$filter.=" AND (title 
							OR description
							LIKE \'%".$modx->db->escape($_GET[\'search\'])."%\')";
	//check filter datum for "country"
	if (!empty($_GET[\'country\'])) 
		$filter .= " AND t.country=\'".$modx->db->escape($_GET[\'country\'])."\'";
	//check filter datum for "type"
	if (!empty($_GET[\'type\'])){ 
		if (is_array($_GET[\'type\']))
			foreach($_GET[\'type\'] as $a) {
				$filter_type .= " AND 
									(SELECT COUNT(*) 
										FROM `modx_a_alantur_orders_type`
											WHERE id_tour = t.id 
											AND id_type = \'".$modx->db->escape($a)."\') > 0 ";
			}	
		else $filter_type .= " AND
								(SELECT COUNT(*) 
									FROM `modx_a_alantur_orders_type`
										WHERE
											id_tour = t.id 
										AND id_type = \'".$modx->db->escape($_GET[\'type\'])."\') > 0 ";
	}
	
	$res = "";
	//show all tours which satisfy to condition
	$data_query = $modx->db->query("
		SELECT 
			SQL_CALC_FOUND_ROWS * ,
				(SELECT COUNT(*)
					FROM `modx_a_alantur_orders` 
					WHERE 
						id_country = t.country) 
					AS \'reports\',
				(SELECT pagetitle 
					FROM `modx_site_content`
					WHERE 
					id = t.country) AS \'country\'
					FROM `modx_a_alantur_tours` t 
					WHERE 1".$filter." ".$filter_type." 
					LIMIT ".$min.", 12"
	);
	while ($data = $modx->db->getRow($data_query)) {
		$data[\'image\'] = "/assets/images/".$data[\'id\']."/".$data[\'cover\'];	
		$res .= $modx->parseChunk($tpl, $data);
	}
	$count = $modx->db->getRow($modx->db->query("SELECT FOUND_ROWS() AS \'count\'"));
	$modx->setPlaceholder("page", $count[\'count\']);
	if(empty($res))
		$res = "Нет туров удовлетворяющих условию";
	return $res;
';
$s['Auth'] = '
/*
    Авторизация веб-пользователя
    Входные данные
    @username - логин
    @password - пароль
    @redirect - id куда сделать редирект 
    Выходные данные
    >11       - Логин не найден в базе
    >12       - Аккаунт заблокирован
    >13       - Неверный пароль
    >20   - Всё хорошо
    
*/  

    if ($username == "") return 0;
    $username   = $modx->db->escape(strip_tags($username));
    $password   = md5($password);
    $time       = time();
    $query      = "select *, u.id as \'uid\'
                     from `modx_web_users` u
                     join `modx_web_user_attributes` a on a.internalKey = u.id
                     left join `modx_web_groups` g on g.webuser = u.id
                     where a.email = \'$username\' or u.username = \'$username\'";
//die($query);
    $valid_user = $modx->db->getRow($modx->db->query($query));
if ($_SESSION[\'mgrValidated\']) $autologin = true;

    // пользователь тупо не найден = логин не верен
    if ($valid_user[\'username\'] == "") {
		//$modx->regClientScript(\'<script type="text/javascript">alert("Пользователь с такими данными не найден!")</script>\');
        return 11;
    }
if (!$autologin) {

    // пользователь заблокирован
    if ($valid_user[\'blocked\']  == 1 && $valid_user[\'blockeduntil\'] > $time) {
		//$modx->regClientScript(\'<script type="text/javascript">alert("Ваш аккаунт был заблокирован! Обратитесь к Администрации сайта.")</script>\');
        return 12; 
    }
    // пользователь ввел неверный пароль

    if ($valid_user[\'password\'] != $password) {
      $modx->db->query("update `modx_web_user_attributes`
                        set
                               failedlogincount = failedlogincount + 1
                               ".($valid_user[\'failedlogincount\'] + 1 >= $modx->config[\'failed_login_attempts\'] ?
                               " , blocked = 1, blockedafter = \'".$time."\', blockeduntil = \'".($time + $modx->config[\'blocked_minutes\']*60)."\' " : "")."
                        where internalKey = ".$valid_user[\'uid\']);
	  //$modx->regClientScript(\'<script type="text/javascript">alert("Вы ввели неверный пароль!")</script>\');
      return 13;
    }
}    
    $query = "update `modx_web_user_attributes` set
                    sessionid         = \'".session_id()."\',
                    logincount        = logincount + 1,
                    lastlogin         = \'".$time."\'
                    where internalKey = ".$valid_user[\'uid\'];
                  
    $modx->db->query($query);
    /* непонятно зачем так геморно полчаем группы документов доступных пользоваетлю */
    $dg  = \'\';
    $i   = 0;
    $sql = "SELECT uga.documentgroup
            FROM `modx_web_groups` ug
            INNER JOIN `modx_webgroup_access` uga ON uga.webgroup=ug.webgroup
            WHERE ug.webuser =".$valid_user[\'uid\'];

    $ds  = $modx->db->query($sql);
    while ($row = $modx->db->getRow($ds,\'num\')) $dg[$i++] = $row[0];
    /* закончили получать в array $dg лежит */
    $_SESSION[\'webShortname\']           = $valid_user[\'username\'];
    $_SESSION[\'webFullname\']            = $valid_user[\'fullname\'];
    $_SESSION[\'webEmail\']               = $valid_user[\'email\'];
    $_SESSION[\'webValidated\']           = 1;
    $_SESSION[\'webInternalKey\']         = $valid_user[\'internalKey\'];
    $_SESSION[\'webValid\']               = base64_encode($_POST[\'password\']);
    $_SESSION[\'webUser\']                = base64_encode($valid_user[\'username\']);
    $_SESSION[\'webFailedlogins\']        = $valid_user[\'failedlogincount\'];
    $_SESSION[\'webLastlogin\']           = $valid_user[\'lastlogin\'];
    $_SESSION[\'webnrlogins\']            = $valid_user[\'logincount\'];
    $_SESSION[\'webUserGroupNames\']      = $modx->db->getColumn("name", "SELECT wgn.name FROM `modx_webgroup_names` wgn INNER JOIN `modx_web_groups` wg ON wg.webgroup=wgn.id AND wg.webuser=" . $valid_user[\'uid\']);
    $_SESSION[\'webDocgroups\']           = $dg;
    if($_POST[\'rememberme\'] != "yes") {
      $_SESSION[\'modx.web.session.cookie.lifetime\'] = intval($modx->config[\'session.cookie.lifetime\']);
    } else {
      $_SESSION[\'modx.web.session.cookie.lifetime\'] = 0;
    }
	// save to session
	$_SESSION[\'webuser\'] = $valid_user;


           
    // для отображения ОНЛАЙН в админ панели
    if($id!=$modx->documentIdentifier) {
     if (getenv("HTTP_CLIENT_IP")) 
         $ip = getenv("HTTP_CLIENT_IP");
     else if(getenv("HTTP_X_FORWARDED_FOR")) 
             $ip = getenv("HTTP_X_FORWARDED_FOR");
          else if(getenv("REMOTE_ADDR")) 
                  $ip = getenv("REMOTE_ADDR");
               else $ip = "UNKNOWN";
     $_SESSION[\'ip\'] = $ip;
     $itemid = isset($_REQUEST[\'id\']) ? $_REQUEST[\'id\'] : \'NULL\' ;
     $a = 998;
     if($a!=1) {
        // web users are stored with negative id
        $sql = "REPLACE INTO `modx_active_users` (internalKey, username, lasthit, action, id, ip) values(-".$_SESSION[\'webInternalKey\'].", \'".$_SESSION[\'webShortname\']."\', \'".$time."\', \'".$a."\', ".$itemid.", \'$ip\')";
        $modx->db->query($sql);
     }
    }
    return 20;
';
$s['captcha'] = '
	switch ($get){
		//set captcha key on contact page
		case "show_key":
			return "<div class=\'g-recaptcha\' data-sitekey=\'6LdmZwUTAAAAACWEzyFiLeRbBKPco-dYj0b4jfkN\'></div>";
		break;	
		
		// check valid of captcha
		case "check_captcha":
			$response = file_get_contents("https://www.google.com/recaptcha/api/siteverify?secret=6LdmZwUTAAAAAKjP944t48CXjPYqId8_AoBf4Inf&response=".$capch."&remoteip=".$_SERVER[\'REMOTE_ADDR\']);
			return $response;
		break;
	}
';
$s['recaptcha'] = '
/*
 * This is a PHP library that handles calling reCAPTCHA.
 *    - Documentation and latest version
 *          http://recaptcha.net/plugins/php/
 *    - Get a reCAPTCHA API Key
 *          https://www.google.com/recaptcha/admin/create
 *    - Discussion group
 *          http://groups.google.com/group/recaptcha
 *
 * Copyright (c) 2007 reCAPTCHA -- http://recaptcha.net
 * AUTHORS:
 *   Mike Crawford
 *   Ben Maurer
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

/**
 * The reCAPTCHA server URL\'s
 */
define("RECAPTCHA_API_SERVER", "http://www.google.com/recaptcha/api");
define("RECAPTCHA_API_SECURE_SERVER", "https://www.google.com/recaptcha/api");
define("RECAPTCHA_VERIFY_SERVER", "www.google.com");

/**
 * Encodes the given data into a query string format
 * @param $data - array of string elements to be encoded
 * @return string - encoded request
 */
function _recaptcha_qsencode ($data) {
        $req = "";
        foreach ( $data as $key => $value )
                $req .= $key . \'=\' . urlencode( stripslashes($value) ) . \'&\';

        // Cut the last \'&\'
        $req=substr($req,0,strlen($req)-1);
        return $req;
}



/**
 * Submits an HTTP POST to a reCAPTCHA server
 * @param string $host
 * @param string $path
 * @param array $data
 * @param int port
 * @return array response
 */
function _recaptcha_http_post($host, $path, $data, $port = 80) {

        $req = _recaptcha_qsencode ($data);

        $http_request  = "POST $path HTTP/1.0\\r\\n";
        $http_request .= "Host: $host\\r\\n";
        $http_request .= "Content-Type: application/x-www-form-urlencoded;\\r\\n";
        $http_request .= "Content-Length: " . strlen($req) . "\\r\\n";
        $http_request .= "User-Agent: reCAPTCHA/PHP\\r\\n";
        $http_request .= "\\r\\n";
        $http_request .= $req;

        $response = \'\';
        if( false == ( $fs = @fsockopen($host, $port, $errno, $errstr, 10) ) ) {
                die (\'Could not open socket\');
        }

        fwrite($fs, $http_request);

        while ( !feof($fs) )
                $response .= fgets($fs, 1160); // One TCP-IP packet
        fclose($fs);
        $response = explode("\\r\\n\\r\\n", $response, 2);

        return $response;
}



/**
 * Gets the challenge HTML (javascript and non-javascript version).
 * This is called from the browser, and the resulting reCAPTCHA HTML widget
 * is embedded within the HTML form it was called from.
 * @param string $pubkey A public key for reCAPTCHA
 * @param string $error The error given by reCAPTCHA (optional, default is null)
 * @param boolean $use_ssl Should the request be made over ssl? (optional, default is false)

 * @return string - The HTML to be embedded in the user\'s form.
 */
function recaptcha_get_html ($pubkey, $error = null, $use_ssl = false)
{
        if ($pubkey == null || $pubkey == \'\') {
                die ("To use reCAPTCHA you must get an API key from <a href=\'https://www.google.com/recaptcha/admin/create\'>https://www.google.com/recaptcha/admin/create</a>");
        }
        
        if ($use_ssl) {
                $server = RECAPTCHA_API_SECURE_SERVER;
        } else {
                $server = RECAPTCHA_API_SERVER;
        }

        $errorpart = "";
        if ($error) {
           $errorpart = "&amp;error=" . $error;
        }
        return \'<script type="text/javascript" src="\'. $server . \'/challenge?k=\' . $pubkey . $errorpart . \'"></script>

        <noscript>
                <iframe src="\'. $server . \'/noscript?k=\' . $pubkey . $errorpart . \'" height="300" width="500" frameborder="0"></iframe><br/>
                <textarea name="recaptcha_challenge_field" rows="3" cols="40"></textarea>
                <input type="hidden" name="recaptcha_response_field" value="manual_challenge"/>
        </noscript>\';
}




/**
 * A ReCaptchaResponse is returned from recaptcha_check_answer()
 */
class ReCaptchaResponse {
        var $is_valid;
        var $error;
}


/**
  * Calls an HTTP POST function to verify if the user\'s guess was correct
  * @param string $privkey
  * @param string $remoteip
  * @param string $challenge
  * @param string $response
  * @param array $extra_params an array of extra variables to post to the server
  * @return ReCaptchaResponse
  */
function recaptcha_check_answer ($privkey, $remoteip, $challenge, $response, $extra_params = array())
{
        if ($privkey == null || $privkey == \'\') {
                die ("To use reCAPTCHA you must get an API key from <a href=\'https://www.google.com/recaptcha/admin/create\'>https://www.google.com/recaptcha/admin/create</a>");
        }

        if ($remoteip == null || $remoteip == \'\') {
                die ("For security reasons, you must pass the remote ip to reCAPTCHA");
        }

        
        
        //discard spam submissions
        if ($challenge == null || strlen($challenge) == 0 || $response == null || strlen($response) == 0) {
                $recaptcha_response = new ReCaptchaResponse();
                $recaptcha_response->is_valid = false;
                $recaptcha_response->error = \'incorrect-captcha-sol\';
                return $recaptcha_response;
        }

        $response = _recaptcha_http_post (RECAPTCHA_VERIFY_SERVER, "/recaptcha/api/verify",
                                          array (
                                                 \'privatekey\' => $privkey,
                                                 \'remoteip\' => $remoteip,
                                                 \'challenge\' => $challenge,
                                                 \'response\' => $response
                                                 ) + $extra_params
                                          );

        $answers = explode ("\\n", $response [1]);
        $recaptcha_response = new ReCaptchaResponse();

        if (trim ($answers [0]) == \'true\') {
                $recaptcha_response->is_valid = true;
        }
        else {
                $recaptcha_response->is_valid = false;
                $recaptcha_response->error = $answers [1];
        }
        return $recaptcha_response;

}

/**
 * gets a URL where the user can sign up for reCAPTCHA. If your application
 * has a configuration page where you enter a key, you should provide a link
 * using this function.
 * @param string $domain The domain where the page is hosted
 * @param string $appname The name of your application
 */
function recaptcha_get_signup_url ($domain = null, $appname = null) {
        return "https://www.google.com/recaptcha/admin/create?" .  _recaptcha_qsencode (array (\'domains\' => $domain, \'app\' => $appname));
}

function _recaptcha_aes_pad($val) {
        $block_size = 16;
        $numpad = $block_size - (strlen ($val) % $block_size);
        return str_pad($val, strlen ($val) + $numpad, chr($numpad));
}

/* Mailhide related code */

function _recaptcha_aes_encrypt($val,$ky) {
        if (! function_exists ("mcrypt_encrypt")) {
                die ("To use reCAPTCHA Mailhide, you need to have the mcrypt php module installed.");
        }
        $mode=MCRYPT_MODE_CBC;   
        $enc=MCRYPT_RIJNDAEL_128;
        $val=_recaptcha_aes_pad($val);
        return mcrypt_encrypt($enc, $ky, $val, $mode, "\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0");
}


function _recaptcha_mailhide_urlbase64 ($x) {
        return strtr(base64_encode ($x), \'+/\', \'-_\');
}

/* gets the reCAPTCHA Mailhide url for a given email, public key and private key */
function recaptcha_mailhide_url($pubkey, $privkey, $email) {
        if ($pubkey == \'\' || $pubkey == null || $privkey == "" || $privkey == null) {
                die ("To use reCAPTCHA Mailhide, you have to sign up for a public and private key, " .
                     "you can do so at <a href=\'http://www.google.com/recaptcha/mailhide/apikey\'>http://www.google.com/recaptcha/mailhide/apikey</a>");
        }
        

        $ky = pack(\'H*\', $privkey);
        $cryptmail = _recaptcha_aes_encrypt ($email, $ky);
        
        return "http://www.google.com/recaptcha/mailhide/d?k=" . $pubkey . "&c=" . _recaptcha_mailhide_urlbase64 ($cryptmail);
}

/**
 * gets the parts of the email to expose to the user.
 * eg, given johndoe@example,com return ["john", "example.com"].
 * the email is then displayed as john...@example.com
 */
function _recaptcha_mailhide_email_parts ($email) {
        $arr = preg_split("/@/", $email );

        if (strlen ($arr[0]) <= 4) {
                $arr[0] = substr ($arr[0], 0, 1);
        } else if (strlen ($arr[0]) <= 6) {
                $arr[0] = substr ($arr[0], 0, 3);
        } else {
                $arr[0] = substr ($arr[0], 0, 4);
        }
        return $arr;
}

/**
 * Gets html to display an email address given a public an private key.
 * to get a key, go to:
 *
 * http://www.google.com/recaptcha/mailhide/apikey
 */
function recaptcha_mailhide_html($pubkey, $privkey, $email) {
        $emailparts = _recaptcha_mailhide_email_parts ($email);
        $url = recaptcha_mailhide_url ($pubkey, $privkey, $email);
        
        return htmlentities($emailparts[0]) . "<a href=\'" . htmlentities ($url) .
                "\' onclick=\\"window.open(\'" . htmlentities ($url) . "\', \'\', \'toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=500,height=300\'); return false;\\" title=\\"Reveal this e-mail address\\">...</a>@" . htmlentities ($emailparts [1]);

}


';
$p = &$this->pluginCache;
$p['CodeMirror'] = '$_CM_BASE = \'assets/plugins/codemirror/\';

$_CM_URL = $modx->config[\'site_url\'] . $_CM_BASE;

require(MODX_BASE_PATH. $_CM_BASE .\'codemirror.plugin.php\');

';
$p['CodeMirrorProps'] = '&theme=Theme;list;default,ambiance,blackboard,cobalt,eclipse,elegant,erlang-dark,lesser-dark,midnight,monokai,neat,night,rubyblue,solarized,twilight,vibrant-ink,xq-dark,xq-light; &indentUnit=Indent unit;int;4 &tabSize=The width of a tab character;int;4 &lineWrapping=lineWrapping;list;true,false;true &matchBrackets=matchBrackets;list;true,false;true &activeLine=activeLine;list;true,false;false &emmet=emmet;list;true,false;true &search=search;list;true,false;true ';
$p['CodeMirror'] = '$_CM_BASE = \'assets/plugins/codemirror/\';

$_CM_URL = $modx->config[\'site_url\'] . $_CM_BASE;

require(MODX_BASE_PATH. $_CM_BASE .\'codemirror.plugin.php\');

';
$p['CodeMirrorProps'] = '&theme=Theme;list;default,ambiance,blackboard,cobalt,eclipse,elegant,erlang-dark,lesser-dark,midnight,monokai,neat,night,rubyblue,solarized,twilight,vibrant-ink,xq-dark,xq-light; &indentUnit=Indent unit;int;4 &tabSize=The width of a tab character;int;4 &lineWrapping=lineWrapping;list;true,false;true &matchBrackets=matchBrackets;list;true,false;true &activeLine=activeLine;list;true,false;false &emmet=emmet;list;true,false;true &search=search;list;true,false;true ';
$p['TinyMCE Rich Text Editor'] = 'require MODX_BASE_PATH.\'assets/plugins/tinymce/plugin.tinymce.php\';
';
$p['TinyMCE Rich Text EditorProps'] = '&customparams=Custom Parameters;textarea;valid_elements : "*[*]", &mce_formats=Block Formats;text;p,h1,h2,h3,h4,h5,h6,div,blockquote,code,pre &entity_encoding=Entity Encoding;list;named,numeric,raw;named &entities=Entities;text; &mce_path_options=Path Options;list;Site config,Absolute path,Root relative,URL,No convert;Site config &mce_resizing=Advanced Resizing;list;true,false;true &disabledButtons=Disabled Buttons;text; &link_list=Link List;list;enabled,disabled;enabled &webtheme=Web Theme;list;simple,editor,creative,custom;simple &webPlugins=Web Plugins;text;style,advimage,advlink,searchreplace,contextmenu,paste,fullscreen,xhtmlxtras,media &webButtons1=Web Buttons 1;text;undo,redo,selectall,|,pastetext,pasteword,|,search,replace,|,hr,charmap,|,image,link,unlink,anchor,media,|,cleanup,removeformat,|,fullscreen,code,help &webButtons2=Web Buttons 2;text;bold,italic,underline,strikethrough,sub,sup,|,|,blockquote,bullist,numlist,outdent,indent,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect,|,styleprops &webButtons3=Web Buttons 3;text; &webButtons4=Web Buttons 4;text; &webAlign=Web Toolbar Alignment;list;ltr,rtl;ltr &width=Width;text;100% &height=Height;text;500 ';
$p['TinyMCE Rich Text Editor'] = 'require MODX_BASE_PATH.\'assets/plugins/tinymce/plugin.tinymce.php\';
';
$p['TinyMCE Rich Text EditorProps'] = '&customparams=Custom Parameters;textarea;valid_elements : "*[*]", &mce_formats=Block Formats;text;p,h1,h2,h3,h4,h5,h6,div,blockquote,code,pre &entity_encoding=Entity Encoding;list;named,numeric,raw;named &entities=Entities;text; &mce_path_options=Path Options;list;Site config,Absolute path,Root relative,URL,No convert;Site config &mce_resizing=Advanced Resizing;list;true,false;true &disabledButtons=Disabled Buttons;text; &link_list=Link List;list;enabled,disabled;enabled &webtheme=Web Theme;list;simple,editor,creative,custom;simple &webPlugins=Web Plugins;text;style,advimage,advlink,searchreplace,contextmenu,paste,fullscreen,xhtmlxtras,media &webButtons1=Web Buttons 1;text;undo,redo,selectall,|,pastetext,pasteword,|,search,replace,|,hr,charmap,|,image,link,unlink,anchor,media,|,cleanup,removeformat,|,fullscreen,code,help &webButtons2=Web Buttons 2;text;bold,italic,underline,strikethrough,sub,sup,|,|,blockquote,bullist,numlist,outdent,indent,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect,|,styleprops &webButtons3=Web Buttons 3;text; &webButtons4=Web Buttons 4;text; &webAlign=Web Toolbar Alignment;list;ltr,rtl;ltr &width=Width;text;100% &height=Height;text;500 ';
$p['Forgot Manager Login'] = 'require MODX_BASE_PATH.\'assets/plugins/forgotmanagerlogin/plugin.forgotmanagerlogin.php\';';
$p['Forgot Manager Login'] = 'require MODX_BASE_PATH.\'assets/plugins/forgotmanagerlogin/plugin.forgotmanagerlogin.php\';';
$p['TransAlias'] = 'require MODX_BASE_PATH.\'assets/plugins/transalias/plugin.transalias.php\';';
$p['TransAliasProps'] = '&table_name=Trans table;list;common,russian,dutch,german,czech,utf8,utf8lowercase;utf8lowercase &char_restrict=Restrict alias to;list;lowercase alphanumeric,alphanumeric,legal characters;legal characters &remove_periods=Remove Periods;list;Yes,No;No &word_separator=Word Separator;list;dash,underscore,none;dash &override_tv=Override TV name;string; ';
$p['FileSource'] = 'require MODX_BASE_PATH.\'assets/plugins/filesource/plugin.filesource.php\';';
$p['FileSource'] = 'require MODX_BASE_PATH.\'assets/plugins/filesource/plugin.filesource.php\';';
$p['ManagerManager'] = '// You can put your ManagerManager rules EITHER in a chunk OR in an external file - whichever suits your development style the best

// To use an external file, put your rules in /assets/plugins/managermanager/mm_rules.inc.php 
// (you can rename default.mm_rules.inc.php and use it as an example)
// The chunk SHOULD have php opening tags at the beginning and end

// If you want to put your rules in a chunk (so you can edit them through the Manager),
// create the chunk, and enter its name in the configuration tab.
// The chunk should NOT have php tags at the beginning or end.

// See also user-friendly module for editing ManagerManager configuration file ddMMEditor (http://code.divandesign.biz/modx/ddmmeditor).

// ManagerManager requires jQuery 1.9.1, which is located in /assets/plugins/managermanager/js/ folder.

// You don\'t need to change anything else from here onwards
//-------------------------------------------------------

// Run the main code
include($modx->config[\'base_path\'].\'assets/plugins/managermanager/mm.inc.php\');';
$p['ManagerManagerProps'] = '&remove_deprecated_tv_types_pref=Remove deprecated TV types;list;yes,no;yes &config_chunk=Configuration Chunk;text;mm_rules ';
$p['ManagerManager'] = '// You can put your ManagerManager rules EITHER in a chunk OR in an external file - whichever suits your development style the best

// To use an external file, put your rules in /assets/plugins/managermanager/mm_rules.inc.php 
// (you can rename default.mm_rules.inc.php and use it as an example)
// The chunk SHOULD have php opening tags at the beginning and end

// If you want to put your rules in a chunk (so you can edit them through the Manager),
// create the chunk, and enter its name in the configuration tab.
// The chunk should NOT have php tags at the beginning or end.

// See also user-friendly module for editing ManagerManager configuration file ddMMEditor (http://code.divandesign.biz/modx/ddmmeditor).

// ManagerManager requires jQuery 1.9.1, which is located in /assets/plugins/managermanager/js/ folder.

// You don\'t need to change anything else from here onwards
//-------------------------------------------------------

// Run the main code
include($modx->config[\'base_path\'].\'assets/plugins/managermanager/mm.inc.php\');';
$p['ManagerManagerProps'] = '&remove_deprecated_tv_types_pref=Remove deprecated TV types;list;yes,no;yes &config_chunk=Configuration Chunk;text;mm_rules ';
$p['Общий плагин'] = 'switch($modx->event->name){
	//silent download of current tour
		
	case "OnPageNotFound":
		//А если есть - работаем дальше
		$request = $modx->db->escape($_REQUEST[\'q\']);
		$tmp = explode(\'/\',$request);
		//ссылка подходит под указанный формат: item/urldecode
		if($tmp[0] == "tours" && count($tmp >= 2)){
			//Если очищенное имя не равно запрошенному - то можно отредиректить юзера
			//Также возможен вариант с косой в конце бенда - его тоже учитываем
			//сеошники должны оценить
			$data_query = "SELECT * FROM `modx_a_alantur_tours`	WHERE path=\'".$tmp[1]."\'";
			$data_query = $modx->db->getRow($modx->db->query($data_query));
			if(isset($data_query[\'id\'])){
				$_GET[\'id\'] = $data_query[\'id\'];
				$modx->sendForward(11);	
			}
		}
	break;	
		
	case \'OnLoadWebDocument\': 
	
	//form information for one tour\'s page
	// Datum we catch from "onNotFound" part of plugin
		if(isset($_GET[\'id\'])){
			$id = (int)$_GET[\'id\'];
			$_GET = $modx->db->getRow($modx->db->query("
			SELECT 
				*
			FROM `modx_a_alantur_tours`
			WHERE 
				id = \'".$id."\'"));
			$data_flow = $modx->db->query("SELECT id_type 
												FROM `modx_a_alantur_orders_type` 
												WHERE id_tour = \'".$id."\'");
			while ($type_array = $modx->db->getRow($data_flow)){
				$_GET[\'type\'][] = $type_array[\'id_type\'];	
			}
			$detail = $modx->runSnippet("snippet",array("get"=>"one_tour"));
			$html = $modx->documentObject = array_merge($modx->documentObject, $detail);
		}
	
		if (is_array($_SESSION[\'webuser\']))
			foreach($_SESSION[\'webuser\'] as $key => $value)
				$modx->documentObject[\'user_\'.$key] = $value;
	
		if($_GET[\'type\']){
			$type = implode(",", $_GET[\'type\']);
			$modx->documentObject[\'type\']=$type;
		}
	break;


	
	case "OnWebPageInit":
		if (strtolower($_SERVER[\'HTTP_X_REQUESTED_WITH\']) == \'xmlhttprequest\'){
			switch ($_REQUEST[\'ajax\']) {
							
				// user\'s logout
				case "logout":
					unset($_SESSION["webuser"]);
				break;
				
						
				// write order tour to database for staff
				case "sale":
					if($_POST[\'buy\']){
						//check balance of user to possibility to buy tour
						$pos =	$modx->db->getValue($modx->db->query(
							"SELECT SUM(balance) - ".(int)$_POST[\'buy\'][\'price\']."
								FROM `modx_a_alantur_balance` 
								WHERE
									user_id = \'".(int)$_POST[\'buy\'][\'user\']."\'"));
						if($pos > 0){
							$sql = $modx->db->query(
								"INSERT INTO `modx_a_alantur_tours_sale`
									SET
										status = 1,
										user_id = \'".(int)$_POST[\'buy\'][\'user\']."\', 
										tour_id = \'".(int)$_POST[\'buy\'][\'tour\']."\'");
								$modx->db->query(
									"INSERT INTO modx_a_alantur_balance 
										SET 
											balance = \'-".(int)$_POST[\'buy\'][\'price\']."\',
											user_id = \'".(int)$_POST[\'buy\'][\'user\']."\',
											direction = \'2\',
											payment=\'".(int)$_POST[\'buy\'][\'tour\']."\'"); 
							die("1");
						}
						else die("2");
					}
				break;
				
						
				// User\'s registration auth by ajax						
				case "reg":
					if($_POST[\'reg\'] > 0) {
						$pass = md5($_POST[\'reg\']["pass"]);
						$data = $modx->db->getValue($modx->db->query("SELECT id 
																		FROM `modx_web_users` 
																		WHERE
																		username = \'".$modx->db->escape($_POST[\'reg\']["email"])."\'"
																	)
												   );
						if($data){
							$res = "13";
						}
						else{
							//insert username and pass to table web users
								$modx->db->query("INSERT INTO modx_web_users 
															SET
																username = \'".$modx->db->escape($_POST[\'reg\'][\'email\'])."\', 
																password = \'".$pass."\'"
												);
							
							//получение id пользователя после его занесение в modx_web_users
							$id = $modx->db->getInsertId();
						
							//Запись id, email и и чекбокса подписки в базу modx_web_user_attributes
							$modx->db->query("INSERT INTO modx_web_user_attributes
															SET
																email = \'".$modx->db->escape($_POST[\'reg\'][\'email\'])."\', 
																internalKey = \'".$id."\'"
											);
							
							//запись id пользователя в webusergroup чтобы он стал авторизированным
							$modx->db->query("INSERT INTO modx_web_groups 
															SET
																webgroup = \'1\', 
																webuser = \'".$id."\'"
											);		
							
							//Запись id, в таблицу баланса
							$modx->db->query("INSERT INTO modx_a_alantur_balance
															SET
																balance = \'1000\',
																payment = \'-1\',
																direction = \'1\',
																user_id = \'".$id."\'"
											);
							
							//авторизация пользователя после регистрации
							
							$modx->runSnippet("Auth", array("username" => $modx->db->escape($_POST[\'reg\'][\'email\']),
											"autologin" => true
														   )
											 );
							$res="20";
						}
					}
				//	die ("20");
				//	else $res = "1";
					
				break;//end of reg case
					
				// user auth by ajax						
				case "auth":
					$answer = $modx->runSnippet("Auth", array("username" => $modx->db->escape($_POST["email"]),
															  "password" => $modx->db->escape($_POST["pass"])
															 )
											   );
					$res=$answer;
					// without these 2 strings we don\'t recieve ajax answer 
					echo $res; 
					die ();
				break;
										
								
				// delete photo from report by ajax
				case "del_foto":
					if ((int)$_POST[\'foto\'] > 0){
						$modx->db->query("DELETE
											FROM `modx_a_alantur_orders_detail`
											WHERE
												id_photo = \'".$modx->db->escape($_POST[\'foto\'])."\'");
						unlink(MODX_BASE_PATH."/assets/images/reports/".$modx->db->escape($_POST[\'order\'])."/".$modx->db->escape($_POST[\'fotoname\']));
						return false;
					}
				break;
				
											
				//delete all from report
				case "del_report":
					$id = (int)$_POST[\'order\'];
					if ($id > 0){
						$modx->db->query("DELETE 
											FROM `modx_a_alantur_orders_detail` 
											WHERE
												id_order = \'".$id."\'"
										);
						$modx->db->query("DELETE FROM `modx_a_alantur_orders` WHERE id_order = \'".$id."\'");
						$modx->db->query("DELETE 
											FROM `modx_a_alantur_orders_voting` 
											WHERE
												id_report = \'".$id."\'"
										);
						$path = MODX_BASE_PATH.\'assets/images/reports/\'.$id;
						$folder = glob($path);
						if ($folder = glob($path."/*")) {
							foreach($folder as $obj) {
								unlink($obj);
							}
						}
						rmdir($path);
					}
					//$res = false;	
					die();
				break;
								
							
				case "feedback":
					$answer = $modx->runSnippet("captcha", array("get"=>"check_captcha", 
																 "capch" => $modx->db->escape($_POST[\'captcha\'])
																)
											   );
					$answer = json_decode($answer, true);
					if($answer == true)	{
						$tpl = "email_letter";
						$tpl_letter = $modx->parseChunk($tpl, $_POST);
						$modx->runSnippet("Snippet",
												Array(
													"to" => "lizazz@yandex.ru",
													"get" => "sendmail",
													"subject" => "Письмо обратной связи",
													"body" => $tpl_letter)
										 );
					}
					else  $res = "Возникла проблема при проверке CAPTCHA Вам прийдется еще раз ввести данные";
				break;
				
			
				
				// vote for favorite report		
									
				case "vote-report":
					if ((int)$_POST[\'report\'] > 0){
						$modx->db->query("INSERT INTO modx_a_alantur_orders_voting
															SET 
																id_report = \'".(int)$_POST[\'report\']."\',
																rate = \'".(int)$_POST[\'rate\']."\',
																ip_voter = INET_ATON(\'".$_SERVER["REMOTE_ADDR"]."\')
															ON DUPLICATE KEY UPDATE 
																rate = \'".(int)$_POST[\'rate\']."\',
																id_report = \'".(int)$_POST[\'report\']."\'"
										);
						$avg_rate=$modx->db->getValue($modx->db->query("SELECT AVG(rate) 
																			FROM modx_a_alantur_orders_voting
																				WHERE 
																					id_report = \'".(int)$_POST[\'report\']."\'"
																	  )
													 );
						$modx->db->query("UPDATE modx_a_alantur_orders 
																	SET 
																		average = \'".$avg_rate."\'
																	WHERE 
																		id_order = \'".(int)$_POST[\'report\']."\'"
										);
					}
				break;
				
			} // end switch ajax
			die ($res); // return result of switch ajax
		}  // end switch if
				
				
					
		//change user datum
		if(0 < count($_POST[\'user\'])){
			$name = $modx->db->escape($_POST[\'user\']["name"]);
			$email = $modx->db->escape($_POST[\'user\']["email"]);
			if(!empty($name)) {
				$_SESSION ["webuser"]["fullname"] = $name;
				$name = "fullname = \'".$name."\'";
				$write = 1;
			}else
				$name = "";
			if(!empty($email)) {
				$_SESSION ["webuser"]["email"] = $email;
				$email = "email = \'".$email."\'";
				$write = 1;
			}else
				$email = "";
			if(!empty($name) and !empty($email))
				$coma = ",";
				//$write отвечает за то писать в БД или запрос пустой
			if($write=1){
				$modx->db->query("UPDATE modx_web_user_attributes SET 
												".$name.$coma."
												".$email."
												 WHERE internalKey = \'".$_SESSION[\'webuser\'][\'internalKey\']."\'"
								);
			}
			
			$nick = $modx->db->escape($_POST[\'user\']["nick"]);
			$password = $modx->db->escape($_POST[\'user\']["new_password"]);
			$old_pass = md5($_POST[\'user\']["old_password"]);
			if(!empty($nick)){
				$_SESSION ["webuser"]["username"] = $nick;
				$nick="username = \'".$nick."\'";
				$write2 = 1;
			}
			else $nick = "";
			if(!empty($password)){
				$check = $modx->db->getRow($modx->db->query("SELECT password 
																FROM `modx_web_users` 
																WHERE 
																	id = \'".$_SESSION[\'webuser\'][\'internalKey\']."\'"
														   )
										  );	
				if($check["password"] != $old_pass)
					die("Вы ввели не верный старый пароль");
				else {
					$password = "password = \'".md5($password)."\'"; $write2 = 1;
				}
				
			}
			if(!empty($nick) and !empty($password))
				$coma2=",";
			//$write отвечает за то писать в БД или запрос пустой
			if($write = 1){
				$modx->db->query("UPDATE modx_web_users SET 
												".$nick.$coma2."
												".$password."
												 WHERE id = \'".$_SESSION[\'webuser\'][\'internalKey\']."\'"
								);	
			}
		} //end if "change user datum"	
		
	
	
	
	
		
		
		
		//save fotos for order
		if (0 < count($_POST[\'order\'])) {
			//сохранения в базе данных
			if ($_POST["upd-desc"] > 0){
				$sort = "";
				foreach($_POST["upd-desc"] as $key => $value){
					$modx->db->query("UPDATE modx_a_alantur_orders_detail
														SET 
															description = \'".$modx->db->escape($value)."\' 
														WHERE
															id_photo = \'".(int)$key."\'"
									);
				}
			}
			$ddd = count($_FILES[\'order\'][\'name\'][\'foto\']);
			$order_id = (int)$_POST[\'order\'][\'id\'];
			for ($i = 0; $i < $ddd; $i++){
				if($_FILES[\'order\'][\'name\'][\'foto\'][$i]){
					$sql="INSERT INTO modx_a_alantur_orders_detail
											SET 
												id_order = \'".$order_id."\',
												photo_name = \'".$modx->db->escape($_FILES[\'order\'][\'name\'][\'foto\'][$i])."\',
												description = \'".$modx->db->escape($_POST[\'order\'][\'description\'][$i])."\'";
													
					$modx->db->query($sql);
						if($_FILES[\'order\'][\'size\'][\'foto\'][$i] > 1024*3*1024){
						echo ("Размер файла превышает три мегабайта");
						exit;
					}
					//    Проверяем загружен ли файл
						if(is_uploaded_file($_FILES[\'order\']["tmp_name"][\'foto\'][$i])){
						//   Если файл загружен успешно, перемещаем его
						//    из временной директории в конечную
							$res=$_FILES[\'order\']["tmp_name"][\'foto\'][$i];
						move_uploaded_file($_FILES["order"]["tmp_name"][\'foto\'][$i],MODX_BASE_PATH."assets/images/reports/".$order_id."/".$modx->db->escape($_FILES[\'order\'][\'name\'][\'foto\'][$i]));
							//die($res);
						
					} else {
						die("Ошибка загрузки файла");
					}
				}
				$sql="UPDATE modx_a_alantur_orders
									SET showing = \'".(int)$_POST[\'condition\']."\'
									WHERE 
										id_order = \'".$order_id."\'";
				$modx->db->query($sql);
				
			}			
			header("Location: ".$modx->makeUrl(16,"","report=".$order_id));
			die;
		} //end case save photo
	
	
		// add new order
	
		if (0 < count($_POST[\'country\'])){
			$sql="INSERT INTO modx_a_alantur_orders SET 
											id_author = \'".$_SESSION[\'webuser\'][\'internalKey\']."\',
											id_country = \'".(int)$_POST[\'country\']."\'";		
			$modx->db->query($sql);
			/*	if(!file_exists("assets/images/reports/".$_SESSION[\'webuser\'][\'internalKey\']))
				mkdir (MODX_BASE_PATH."assets/images/reports/".$_SESSION[\'webuser\'][\'internalKey\']);*/
			$folder = $modx->db->getInsertId($modx);
			mkdir("assets/images/reports/".$folder,0777);
			chmod(MODX_BASE_PATH."assets/images/reports/".$folder,0777); 
			header("Location: ".$modx->makeUrl(12,"","#profile"));
			die;
		}
	
	break;	
} //end main switch';
$e = &$this->pluginEvent;
$e['OnBeforeDocFormSave'] = array('ManagerManager');
$e['OnBeforeManagerLogin'] = array('Forgot Manager Login');
$e['OnBeforePluginFormSave'] = array('FileSource');
$e['OnBeforeSnipFormSave'] = array('FileSource');
$e['OnChunkFormRender'] = array('CodeMirror');
$e['OnDocDuplicate'] = array('ManagerManager');
$e['OnDocFormPrerender'] = array('ManagerManager');
$e['OnDocFormRender'] = array('CodeMirror','ManagerManager');
$e['OnDocFormSave'] = array('ManagerManager');
$e['OnInterfaceSettingsRender'] = array('TinyMCE Rich Text Editor');
$e['OnLoadWebDocument'] = array('Общий плагин');
$e['OnManagerAuthentication'] = array('Forgot Manager Login');
$e['OnManagerLoginFormRender'] = array('Forgot Manager Login');
$e['OnModFormRender'] = array('CodeMirror');
$e['OnPageNotFound'] = array('Общий плагин');
$e['OnPluginFormPrerender'] = array('FileSource');
$e['OnPluginFormRender'] = array('ManagerManager','FileSource','CodeMirror');
$e['OnRichTextEditorInit'] = array('TinyMCE Rich Text Editor');
$e['OnRichTextEditorRegister'] = array('TinyMCE Rich Text Editor');
$e['OnSnipFormPrerender'] = array('FileSource');
$e['OnSnipFormRender'] = array('CodeMirror','FileSource');
$e['OnStripAlias'] = array('TransAlias');
$e['OnTempFormRender'] = array('CodeMirror');
$e['OnTVFormRender'] = array('ManagerManager');
$e['OnWebPageInit'] = array('Общий плагин');

